<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stakehood - Coinflip</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3eef4a;
      --primary-dark: #24cc31;
      --primary-light: #73ff7e;
      --secondary: #16181c;
      --accent: #3eef4a;
      --success: #3eef4a;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-dark: #0d0e11;
      --bg-card: #16181c;
      --bg-card-hover: #1e2127;
      --bg-light: #1e2127;
      --text: #ffffff;
      --text-muted: #9ca3af;
      --border: #24262d;
      --header-height: 70px;
      --sidebar-width: 80px;
      --sidebar-expanded-width: 220px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .header {
      height: 60px;
      background-color: var(--secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px 0 100px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 90;
    }
    .logo {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img {
      height: 32px;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 12px;
      background-color: var(--bg-light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border);
    }
    .user-info:hover {
      background-color: var(--bg-card-hover);
      border-color: var(--primary);
    }
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--bg-dark);
    }
    .main-container {
      display: flex;
      margin-top: var(--header-height);
      min-height: calc(100vh - var(--header-height));
    }
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--secondary);
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 90;
      transition: width 0.3s ease;
    }
    .sidebar:hover {
      width: var(--sidebar-expanded-width);
    }
    .sidebar:hover .menu-text {
      display: block;
    }
    .sidebar:hover .menu-icon {
      margin-right: 12px;
    }
    .sidebar-title {
      text-transform: uppercase;
      font-size: 12px;
      color: var(--text-muted);
      padding: 24px 0 8px 17px;
      letter-spacing: 1px;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .sidebar:hover .sidebar-title {
      opacity: 1;
    }
    .content {
      margin-left: var(--sidebar-width);
      margin-top: 60px;
      padding: 24px;
    }
    .sidebar-menu {
      list-style: none;
      margin-bottom: 24px;
      padding-top: 60px;
    }
    .menu-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      text-decoration: none;
      color: var(--text);
      white-space: nowrap;
    }
    .menu-item:hover {
      background-color: var(--bg-light);
    }
    .menu-item.active {
      background-color: rgba(62, 239, 74, 0.1);
    }
    .menu-item.active .menu-icon {
      color: var(--primary);
    }
    .menu-icon {
      font-size: 18px;
      color: var(--text-muted);
      min-width: 24px;
      text-align: center;
      transition: color 0.2s ease;
    }
    .menu-item:hover .menu-icon {
      color: var(--primary);
    }
    .menu-text {
      display: none;
      transition: opacity 0.2s;
      margin-left: 12px;
      font-weight: 500;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      outline: none;
    }
    .btn-primary {
      background-color: var(--primary);
      color: var(--bg-dark);
    }
    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    .btn-secondary {
      background-color: var(--bg-light);
      color: white;
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background-color: var(--bg-card-hover);
      transform: translateY(-2px);
    }
    .btn-success {
      background-color: var(--success);
      color: var(--bg-dark);
    }
    .btn-success:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background-color: #dc2626;
      transform: translateY(-2px);
    }
    .btn-outline {
      background-color: transparent;
      border: 1.5px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .btn-lg {
      padding: 12px 20px;
      font-size: 16px;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    .btn-icon {
      padding: 8px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card {
      background-color: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-title {
      font-weight: 600;
      font-size: 16px;
    }
    .card-body {
      padding: 20px;
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      padding: 20px;
      background-color: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .stat-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .stat-title {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary);
    }
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .game-card {
      background-color: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .game-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(62, 239, 74, 0.1);
    }
    .game-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .game-creator {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .creator-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--bg-dark);
    }
    .game-status {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 4px;
      background-color: rgba(62, 239, 74, 0.1);
      color: var(--primary);
    }
    .game-body {
      padding: 16px;
    }
    .bet-item {
      display: flex;
      margin-bottom: 12px;
    }
    .skin-image {
      width: 80px;
      height: 80px;
      border-radius: 6px;
      object-fit: cover;
      background-color: var(--bg-light);
      margin-right: 12px;
    }
    .skin-details {
      flex: 1;
    }
    .skin-name {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .skin-value {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 6px;
    }
    .skin-tag {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      color: white;
    }
    .rarity-common {
      background-color: #6b7280;
    }
    .rarity-uncommon {
      background-color: #10b981;
    }
    .rarity-rare {
      background-color: #3b82f6;
    }
    .rarity-epic {
      background-color: #8b5cf6;
    }
    .rarity-legendary {
      background-color: #f59e0b;
    }
    .rarity-mythic {
      background-color: #ef4444;
    }
    .game-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .table-container {
      overflow-x: auto;
      margin-bottom: 24px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    #creator-skins-list {
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 8px;
      margin-right: -8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }
    #join-selected-skins-list {
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 8px;
      margin-right: -8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }
    #join-selected-skins-list::-webkit-scrollbar {
      width: 6px;
    }
    #join-selected-skins-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
    #join-selected-skins-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    #join-selected-skins-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    #creator-skins-list::-webkit-scrollbar {
      width: 6px;
    }
    #creator-skins-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
    #creator-skins-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    #creator-skins-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .data-table th,
    .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .data-table th {
      background-color: var(--bg-card);
      font-weight: 500;
      color: var(--text-muted);
      font-size: 13px;
    }
    .data-table tbody tr {
      background-color: var(--bg-card);
      transition: background-color 0.2s;
    }
    .data-table tbody tr:hover {
      background-color: var(--bg-card-hover);
    }
    .leaderboard-section {
      margin-bottom: 24px;
    }
    .leaderboard-list {
      list-style: none;
      background-color: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }
    .leaderboard-item:hover {
      background-color: var(--bg-card-hover);
    }
    .leaderboard-rank {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 16px;
      border-radius: 50%;
      background-color: var(--bg-light);
    }
    .rank-1 {
      background-color: #fcd34d;
      color: #0f172a;
    }
    .rank-2 {
      background-color: #cbd5e1;
      color: #0f172a;
    }
    .rank-3 {
      background-color: #b45309;
      color: white;
    }
    .leaderboard-player {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .leaderboard-username {
      font-weight: 500;
    }
    .leaderboard-stats {
      font-size: 13px;
      color: var(--text-muted);
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 400px;
    }
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--bg-dark);
    }
    .notification-content {
      flex: 1;
    }
    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .notification-message {
      font-size: 14px;
      color: var(--text-muted);
    }
    .notification-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(13, 14, 17, 0.9);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-container {
      background-color: var(--bg-card);
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      transform: translateY(20px);
      transition: transform 0.2s ease;
      border: 1px solid var(--border);
    }
    .modal-container > div:nth-child(2) {
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }
    .modal-container > div:nth-child(2)::-webkit-scrollbar {
      width: 6px;
    }
    .modal-container > div:nth-child(2)::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
    .modal-container > div:nth-child(2)::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    .modal-container > div:nth-child(2)::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .modal-overlay.active .modal-container {
      transform: translateY(0);
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-weight: 600;
      font-size: 18px;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--bg-light);
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    .flip-container {
      width: 180px;
      height: 180px;
      perspective: 1000px;
      margin: 30px auto;
    }
    .coin {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 3s ease-out;
    }
    .coin-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: 700;
    }
    .heads {
      background: linear-gradient(315deg, var(--primary), var(--primary-dark));
      z-index: 2;
      color: var(--bg-dark);
    }
    .tails {
      background: linear-gradient(315deg, var(--danger), #b91c1c);
      color: white;
      transform: rotateY(180deg);
    }
    .result-row {
      display: flex;
      gap: 20px;
      margin: 30px 0;
    }
    .player-card {
      flex: 1;
      background-color: var(--bg-light);
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--border);
      transition: all 0.2s;
    }
    .player-card.winner {
      border-color: var(--success);
      transform: scale(1.05);
    }
    .player-card.loser {
      opacity: 0.7;
    }
    .player-header {
      background-color: var(--bg-dark);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .player-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--bg-dark);
    }
    .player-name {
      font-weight: 500;
    }
    .player-skin {
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .result-skin-img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      margin-bottom: 12px;
    }
    .result-skin-name {
      font-weight: 500;
      margin-bottom: 4px;
      text-align: center;
    }
    .result-skin-value {
      color: var(--text-muted);
      font-size: 14px;
    }
    .winner-badge {
      display: inline-block;
      padding: 4px 12px;
      background-color: var(--success);
      color: var(--bg-dark);
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }
    .verification-section {
      background-color: var(--bg-light);
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }
    .verification-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 15px;
    }
    .verification-item {
      margin-bottom: 12px;
    }
    .verification-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .verification-value {
      padding: 8px 12px;
      background-color: var(--bg-dark);
      border-radius: 6px;
      font-size: 13px;
      font-family: monospace;
      word-wrap: break-word;
    }
    .verification-info {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 12px;
    }
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background-color: var(--bg-dark);
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--bg-light);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--text-muted);
    }
    .error-message {
      padding: 12px;
      background-color: rgba(239, 68, 68, 0.2);
      color: var(--danger);
      border-radius: 6px;
      margin-top: 12px;
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(10px); }
      100% { transform: translateX(0); }
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--text);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .d-none {
      display: none !important;
    }
    .d-flex {
      display: flex !important;
    }
    .d-grid {
      display: grid !important;
    }
    .justify-content-between {
      justify-content: space-between !important;
    }
    .align-items-center {
      align-items: center !important;
    }
    .me-2 {
      margin-right: 0.5rem !important;
    }
    .mt-3 {
      margin-top: 1rem !important;
    }
    .badge {
      display: inline-block;
      padding: 0.25em 0.4em;
      font-size: 75%;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 0.25rem;
    }
    .bg-primary {
      background-color: var(--primary) !important;
      color: var(--bg-dark) !important;
    }
    .bg-secondary {
      background-color: var(--bg-light) !important;
    }
    .bg-success {
      background-color: var(--success) !important;
      color: var(--bg-dark) !important;
    }
    .bg-danger {
      background-color: var(--danger) !important;
    }
    .bg-warning {
      background-color: var(--warning) !important;
    }
    .bg-purple {
      background-color: var(--accent) !important;
    }
    .text-muted {
      color: var(--text-muted) !important;
    }
    .text-success {
      color: var(--success) !important;
    }
    .text-danger {
      color: var(--danger) !important;
    }
    .shake {
      animation: shake 0.5s;
    }
    .join-game-modal .modal-body {
      padding: 20px;
      color: var(--text);
    }
    .join-game-modal .creator-bet-info {
      background-color: var(--bg-light);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .join-game-modal .creator-info {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .join-game-modal .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    .join-game-modal .form-control {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background-color: var(--bg-light);
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s;
      margin-bottom: 16px;
    }
    .join-game-modal .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    .join-game-modal .form-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .join-game-modal .seed-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .join-game-modal .seed-input {
      flex: 1;
    }
    .join-game-modal .select-wrapper {
      position: relative;
      margin-bottom: 16px;
    }
    .join-game-modal .select-wrapper select {
      appearance: none;
      width: 100%;
      padding: 12px 16px;
      padding-right: 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background-color: var(--bg-light);
      color: var(--text);
      font-size: 14px;
    }
    .join-game-modal .select-wrapper::after {
      content: '\f078';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }
    .join-game-modal .select-wrapper select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .join-game-modal .modal-footer {
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .modal-header {
      border-bottom: 1px solid var(--border);
    }
    #login-required-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-light));
      border: 1px solid var(--border);
      text-align: center;
      padding: 40px 20px !important;
    }
    #login-required-card h2 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 24px;
    }
    @media (max-width: 1100px) {
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 900px) {
      .sidebar {
        width: 0;
      }
      .sidebar:hover {
        width: var(--sidebar-width);
      }
      .content {
        margin-left: 0;
        max-width: 100%;
      }
      .header {
        padding: 0 20px;
      }
    }
    @media (max-width:.600px) {
      .stats-row {
        grid-template-columns: 1fr;
      }
      .games-grid {
        grid-template-columns: 1fr;
      }
      .result-row {
        flex-direction: column;
        gap: 16px;
      }
      .player-card.winner {
        transform: none;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">
      <img src="https://via.placeholder.com/40" alt="">
      Stakehood
    </a>
    <div class="header-actions">
      <button class="btn btn-primary" id="login-btn">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      <div class="user-info" id="user-info" style="display: none;">
        <div class="user-avatar" id="user-avatar">U</div>
        <div>
          <div id="username-display">Username</div>
        </div>
      </div>
    </div>
  </header>
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li>
        <a href="index.html" class="menu-item">
          <i class="fas fa-home menu-icon"></i>
          <span class="menu-text">Home</span>
        </a>
      </li>
      <li>
        <a href="coinflip.html" class="menu-item active">
          <i class="fas fa-coins menu-icon"></i>
          <span class="menu-text">Coinflip</span>
        </a>
      </li>
      <li>
        <a href="inventory.html" class="menu-item">
          <i class="fas fa-box-open menu-icon"></i>
          <span class="menu-text">Inventory</span>
        </a>
      </li>
      <li>
        <a href="profile.html" class="menu-item">
          <i class="fas fa-user menu-icon"></i>
          <span class="menu-text">Profile</span>
        </a>
      </li>
      <li>
        <a href="history.html" class="menu-item">
          <i class="fas fa-history menu-icon"></i>
          <span class="menu-text">History</span>
        </a>
      </li>
      <li>
        <a href="settings.html" class="menu-item">
          <i class="fas fa-cog menu-icon"></i>
          <span class="menu-text">Settings</span>
        </a>
      </li>
      <li>
        <a href="#" class="menu-item" id="logout-btn">
          <i class="fas fa-sign-out-alt menu-icon"></i>
          <span class="menu-text">Logout</span>
        </a>
      </li>
    </ul>
  </aside>
  <main class="content">
    <div id="login-required-card" class="card" style="display: none; margin-bottom: 24px;">
      <div class="card-body" style="text-align: center; padding: 40px 20px;">
        <h2 style="font-size: 24px; margin-bottom: 16px;">Join the Coinflip Action!</h2>
        <p style="color: var(--text-muted); margin-bottom: 24px;">Login with Discord to start creating and joining games.</p>
        <button class="btn btn-primary btn-lg" id="login-btn-card">
          <i class="fab fa-discord" style="font-size: 18px;"></i> Login with Discord
        </button>
      </div>
    </div>
    <div id="games-content">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-gamepad me-2"></i> Total Games
          </div>
          <div class="stat-value" id="total-games">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-money-bill-wave me-2"></i> Total Value Wagered
          </div>
          <div class="stat-value" id="total-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-trophy me-2"></i> Biggest Win
          </div>
          <div class="stat-value" id="biggest-win">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-crown me-2"></i> Top Player
          </div>
          <div class="stat-value" id="top-player">-</div>
        </div>
      </div>
      <div style="margin-bottom: 24px;">
        <div class="section-title">
          Active Games
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" id="create-game-btn">
              <i class="fas fa-plus"></i> Create Game
            </button>
            <button class="btn btn-secondary btn-icon" id="refresh-games-btn">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        <div class="games-grid" id="active-games-list"></div>
        <div id="games-loading" style="text-align: center; padding: 20px; display: none;">
          <div style="display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite;"></div>
          <div style="margin-top: 12px;">Loading games...</div>
        </div>
        <div id="no-games-message" style="text-align: center; padding: 40px 20px; background-color: var(--bg-card); border-radius: 8px; display: none;">
          <div style="font-size: 18px; margin-bottom: 12px;">No active games found</div>
          <div style="color: var(--text-muted); margin-bottom: 20px;">Be the first to create a game!</div>
          <button class="btn btn-primary" id="create-first-game-btn">
            <i class="fas fa-plus"></i> Create Game
          </button>
        </div>
      </div>
      <div style="margin-bottom: 24px;">
        <div class="section-title">Recent Games</div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Creator</th>
                <th>Joiner</th>
                <th>Winner</th>
                <th>Skins</th>
                <th>Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="recent-games-list"></tbody>
          </table>
        </div>
        <div id="no-recent-games" style="text-align: center; padding: 20px; background-color: var(--bg-card); border-radius: 8px; display: none;">
          No recent games found
        </div>
      </div>
      <div class="leaderboard-section">
        <div class="section-title">Top Players</div>
        <ul class="leaderboard-list" id="leaderboard-list"></ul>
        <div id="no-leaderboard" style="text-align: center; padding: 20px; background-color: var(--bg-card); border-radius: 8px; display: none;">
          No leaderboard data available
        </div>
      </div>
    </div>
  </main>
  </div>
  <div class="modal-overlay" id="createGameModal">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Create Coinflip Game</h3>
        <button class="modal-close" id="closeCreateGame">&times;</button>
      </div>
      <div class="modal-body">
        <form id="create-game-form">
          <div class="form-group">
            <label class="form-label">Select skins to bet</label>
            <div id="skin-preview" style="display: none; margin-top: 12px; padding: 16px; background-color: var(--bg-light); border-radius: 8px;">
              <div style="display: flex; gap: 12px;">
                <img src="" alt="Skin preview" id="skin-image" style="width: 80px; height: 80px; border-radius: 6px; object-fit: cover;">
                <div>
                  <div id="skin-name" style="font-weight: 500; margin-bottom: 4px;"></div>
                  <div style="display: flex; gap: 8px; margin-bottom: 4px;">
                    <span id="skin-rarity" class="badge bg-secondary"></span>
                    <span id="skin-value" style="color: var(--text-muted);"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="selected-skins-container" id="selected-skins-container" style="margin-bottom: 16px; display: none;">
              <div class="selected-skins-list" id="selected-skins-list"></div>
              <div class="selected-skins-total" style="margin-top: 8px; font-weight: 500;">
                Total Value: <span id="selected-skins-total-value">0</span>
              </div>
            </div>
            <select class="form-control" id="bet-skin">
              <option value="">Select a skin</option>
            </select>
            <button type="button" id="add-skin-btn" class="btn btn-outline" style="margin-top: 8px;">
              <i class="fas fa-plus"></i> Add Skin
            </button>
            <div style="margin-top: 16px;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="allow-multiple-bets" style="margin-right: 8px; cursor: pointer;">
                <span>Allow joiners to use multiple lower-value skins</span>
              </label>
              <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; margin-left: 24px;">
                When enabled, players can join with multiple skins that add up to your bet value. This may require your approval if skin values don't match exactly.
              </div>
            </div>
            <div id="create-game-error" style="display: none; margin-top: 16px; padding: 12px; background-color: rgba(239, 68, 68, 0.2); color: var(--danger); border-radius: 6px;"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelCreateGame">Cancel</button>
        <button class="btn btn-primary" id="create-game-submit-btn">Create Game</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="joinGameModal">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Join Coinflip Game</h3>
        <button class="modal-close" id="closeJoinGame">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background-color: var(--bg-light); padding: 14px 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
          <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Creator's Bet</div>
          <div style="display: flex; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px; margin-right: 8px;">
              <div style="width: 28px; height: 28px; border-radius: 50%; background-color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: var(--bg-dark);">
                <span id="creator-avatar">B</span>
              </div>
              <span id="creator-username" style="font-weight: 500; color: var(--text);">balikmemoli</span>
            </div>
          </div>
          <div id="creator-skins-list" style="margin-top: 12px; background-color: var(--bg-dark); padding: 12px; border-radius: 6px;">
          </div>
        </div>
        <div id="multiple-bets-info" style="margin-bottom: 16px; padding: 10px 14px; background-color: rgba(62, 239, 74, 0.1); border-radius: 6px; border-left: 3px solid var(--success); display: none;">
          <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
          <span style="color: var(--text);">Multiple lower-value skins allowed for this game</span>
        </div>
        <div id="join-value-indicator" style="display: none; margin-bottom: 16px; font-size: 14px; font-weight: 500; text-align: center; padding: 10px; border-radius: 6px; background-color: rgba(245, 158, 11, 0.1);">
        </div>
        <form id="join-game-form">
          <div id="join-selected-skins-container" style="margin-bottom: 20px; display: none;">
            <div style="font-weight: 500; color: var(--text); margin-bottom: 8px;">Your Selected Skins:</div>
            <div id="join-selected-skins-list" style="background-color: var(--bg-dark); padding: 12px; border-radius: 6px;"></div>
            <div style="margin-top: 8px; font-weight: 500; color: var(--text);">
              Total Value: <span id="join-selected-skins-total-value">0</span>
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: var(--text); margin-bottom: 8px; font-size: 14px;">Select a skin to join with</label>
            <div style="position: relative;">
              <select id="join-skin" style="width: 100%; padding: 12px 16px; appearance: none; background-color: var(--bg-dark); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                <option value="">Select a skin</option>
              </select>
              <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">
                <i class="fas fa-chevron-down"></i>
              </div>
            </div>
            <button type="button" id="add-join-skin-btn" style="margin-top: 8px;" class="btn btn-secondary">
              <i class="fas fa-plus"></i> Add Skin
            </button>
          </div>
          <div id="join-skin-preview" style="display: none; margin-top: 12px; padding: 16px; background-color: var(--bg-light); border-radius: 6px;">
            <div style="display: flex; gap: 12px;">
              <img src="" alt="Skin preview" id="join-skin-image" style="width: 80px; height: 80px; border-radius: 6px; object-fit: cover;">
              <div>
                <div id="join-skin-name" style="font-weight: 500; margin-bottom: 4px;"></div>
                <div style="display: flex; gap: 8px; margin-bottom: 4px;">
                  <span id="join-skin-rarity" class="badge bg-secondary"></span>
                  <span id="join-skin-value" style="color: var(--text-muted);"></span>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: var(--text); margin-bottom: 8px; font-size: 14px;">Client Seed (Optional)</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="client-seed" placeholder="Enter a seed or generate one" style="flex: 1; padding: 12px 16px; background-color: var(--bg-dark); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
              <button type="button" id="generate-seed-btn" style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 42px; border-radius: 6px; background-color: var(--bg-light); border: 1px solid var(--border); color: var(--text); cursor: pointer;">
                <i class="fas fa-random"></i>
              </button>
            </div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
              Client seed is used to ensure fair gameplay. If not provided, a random one will be generated.
            </div>
          </div>
          <div id="join-game-error" style="display: none; background-color: rgba(239, 68, 68, 0.15); color: var(--danger); padding: 12px; border-radius: 6px; margin-top: 16px; font-size: 14px; border-left: 3px solid var(--danger);"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="cancelJoinGame" class="btn btn-secondary">Cancel</button>
        <button id="join-game-submit-btn" class="btn btn-primary">Join Game</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="gameResultModal">
    <div class="modal-container" style="max-width: 600px;">
      <div class="modal-header" id="result-header">
        <h3 class="modal-title" id="result-title">Game Result</h3>
        <button class="modal-close" id="closeResult">&times;</button>
      </div>
      <div class="modal-body">
        <div id="result-animation" class="flip-container">
          <div class="coin" id="coin">
            <div class="coin-face heads">C</div>
            <div class="coin-face tails">J</div>
          </div>
        </div>
        <div class="result-row">
          <div class="player-card creator-card">
            <div class="player-header">
              <div class="player-avatar">C</div>
              <div class="player-name" id="result-creator-name">Creator</div>
            </div>
            <div class="player-skin">
              <img src="https://via.placeholder.com/80" alt="Skin" class="result-skin-img">
              <div class="result-skin-name" id="result-creator-skin">Skin Name</div>
              <div class="result-skin-value">
                <span id="result-creator-value">1000</span> value
              </div>
            </div>
          </div>
          <div class="player-card joiner-card">
            <div class="player-header">
              <div class="player-avatar">J</div>
              <div class="player-name" id="result-joiner-name">Joiner</div>
            </div>
            <div class="player-skin">
              <img src="https://via.placeholder.com/80" alt="Skin" class="result-skin-img">
              <div class="result-skin-name" id="result-joiner-skin">Skin Name</div>
              <div class="result-skin-value">
                <span id="result-joiner-value">1000</span> value
              </div>
            </div>
          </div>
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
          <div class="winner-badge" id="winner-info">Player won and received both skins!</div>
        </div>
        <div class="verification-section">
          <div class="verification-title">Provably Fair Verification</div>
          <div class="verification-item">
            <div class="verification-label">Server Seed</div>
            <div class="verification-value" id="server-seed">-</div>
          </div>
          <div class="verification-item">
            <div class="verification-label">Client Seed</div>
            <div class="verification-value" id="result-client-seed">-</div>
          </div>
          <div class="verification-info">
            The combination of server seed and client seed determines the game's outcome, ensuring fair play.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeResultBtn">Close</button>
        <button class="btn btn-primary" id="play-again-btn">Play Again</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="historyModal">
    <div class="modal-container" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">Your Game History</h3>
        <button class="modal-close" id="closeHistory">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
          <div style="background-color: var(--bg-light); padding: 12px; border-radius: 6px; text-align: center;">
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">Total Games</div>
            <div style="font-size: 20px; font-weight: 600;" id="history-total-games">0</div>
          </div>
          <div style="background-color: var(--bg-light); padding: 12px; border-radius: 6px; text-align: center;">
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">Games Won</div>
            <div style="font-size: 20px; font-weight: 600; color: var(--success);" id="history-games-won">0</div>
          </div>
          <div style="background-color: var(--bg-light); padding: 12px; border-radius: 6px; text-align: center;">
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">Games Lost</div>
            <div style="font-size: 20px; font-weight: 600; color: var(--danger);" id="history-games-lost">0</div>
          </div>
          <div style="background-color: var(--bg-light); padding: 12px; border-radius: 6px; text-align: center;">
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">Win Rate</div>
            <div style="font-size: 20px; font-weight: 600;" id="history-win-rate">0%</div>
          </div>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Game ID</th>
                <th>Role</th>
                <th>Opponent</th>
                <th>Skins</th>
                <th>Result</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="history-list"></tbody>
          </table>
        </div>
        <div id="no-history" style="text-align: center; padding: 40px 20px; background-color: var(--bg-light); border-radius: 8px; display: none;">
          <div style="font-size: 18px; margin-bottom: 12px;">No game history found</div>
          <div style="color: var(--text-muted);">Play some games to see your history here</div>
        </div>
      </div>
    </div>
  </div>
  <div class="notification" id="game-notification">
    <div class="notification-icon">
      <i class="fas fa-bell"></i>
    </div>
    <div class="notification-content">
      <div class="notification-title" id="notification-title">New Notification</div>
      <div class="notification-message" id="notification-message">You have a new notification.</div>
      <div class="notification-actions">
        <button class="btn btn-sm btn-primary" id="notification-action">View</button>
        <button class="btn btn-sm btn-secondary" id="notification-dismiss">Dismiss</button>
      </div>
    </div>
  </div>
  <div style="display: none;" id="auth-buttons"></div>
  <script>
    class BootstrapModal {
      constructor(element) {
        this.element = element;
      }
      show() {
        this.element.classList.add('active');
      }
      hide() {
        this.element.classList.remove('active');
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      window.createGameModal = new BootstrapModal(document.getElementById('createGameModal'));
      window.joinGameModal = new BootstrapModal(document.getElementById('joinGameModal'));
      window.gameResultModal = new BootstrapModal(document.getElementById('gameResultModal'));
      window.historyModal = new BootstrapModal(document.getElementById('historyModal'));
      document.querySelectorAll('.modal-close, #cancelCreateGame, #cancelJoinGame, #closeResultBtn').forEach(el => {
        el.addEventListener('click', function() {
          const modal = this.closest('.modal-overlay');
          modal.classList.remove('active');
        });
      });
      const createFirstGameBtn = document.getElementById('create-first-game-btn');
      if (createFirstGameBtn) {
        createFirstGameBtn.addEventListener('click', () => {
          openCreateGameModal();
        });
      }
      const refreshBtn = document.getElementById('refresh-games-btn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          fetchActiveGames();
        });
      }
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      if (token) {
        console.log("Token found in URL parameters");
        localStorage.setItem('auth_token', token);
        window.history.replaceState({}, document.title, window.location.pathname);
        window.location.reload();
      }
    });
  </script>
  <script src="js/auth-client.js"></script>
  <script>
    const api = 'http://localhost:3000';
    const loginBtn = document.getElementById('login-btn');
    const loginBtnCard = document.getElementById('login-btn-card');
    const logoutBtn = document.getElementById('logout-btn');
    const authButtons = document.getElementById('auth-buttons');
    const userInfo = document.getElementById('user-info');
    const usernameDisplay = document.getElementById('username-display');
    const userAvatar = document.getElementById('user-avatar');
    const loginRequiredCard = document.getElementById('login-required-card');
    const gamesContent = document.getElementById('games-content');
    const userPanel = document.getElementById('user-panel');
    const profileUsername = document.getElementById('profile-username');
    const profileDiscordId = document.getElementById('profile-discord-id');
    const userGamesPlayed = document.getElementById('user-games-played');
    const userGamesWon = document.getElementById('user-games-won');
    const userWinRate = document.getElementById('user-win-rate');
    const userInventoryValue = document.getElementById('user-inventory-value');
    const viewHistoryBtn = document.getElementById('view-history-btn');
    const createGameBtn = document.getElementById('create-game-btn');
    const activeGamesList = document.getElementById('active-games-list');
    const recentGamesList = document.getElementById('recent-games-list');
    const noGamesMessage = document.getElementById('no-games-message');
    const noRecentGames = document.getElementById('no-recent-games');
    const gamesLoading = document.getElementById('games-loading');
    const totalGamesElement = document.getElementById('total-games');
    const totalValueElement = document.getElementById('total-value');
    const biggestWinElement = document.getElementById('biggest-win');
    const topPlayerElement = document.getElementById('top-player');
    const leaderboardList = document.getElementById('leaderboard-list');
    const noLeaderboard = document.getElementById('no-leaderboard');
    const betSkinSelect = document.getElementById('bet-skin');
    const allowMultipleBetsCheckbox = document.getElementById('allow-multiple-bets');
    let skinPreview = document.getElementById('skin-preview');
    let skinImage = document.getElementById('skin-image');
    let skinName = document.getElementById('skin-name');
    let skinRarity = document.getElementById('skin-rarity');
    let skinValue = document.getElementById('skin-value');
    const createGameForm = document.getElementById('create-game-form');
    const createGameSubmitBtn = document.getElementById('create-game-submit-btn');
    const createGameError = document.getElementById('create-game-error');
    const creatorUsername = document.getElementById('creator-username');
    const joinSkinSelect = document.getElementById('join-skin');
    let joinSkinPreview = document.getElementById('join-skin-preview');
    let joinSkinImage = document.getElementById('join-skin-image');
    let joinSkinName = document.getElementById('join-skin-name');
    let joinSkinRarity = document.getElementById('join-skin-rarity');
    let joinSkinValue = document.getElementById('join-skin-value');
    const clientSeedInput = document.getElementById('client-seed');
    const generateSeedBtn = document.getElementById('generate-seed-btn');
    const joinGameForm = document.getElementById('join-game-form');
    const joinGameSubmitBtn = document.getElementById('join-game-submit-btn');
    const joinGameError = document.getElementById('join-game-error');
    const resultHeader = document.getElementById('result-header');
    const resultAnimation = document.getElementById('result-animation');
    const coin = document.getElementById('coin');
    const resultTitle = document.getElementById('result-title');
    const resultCreatorName = document.getElementById('result-creator-name');
    const resultCreatorSkin = document.getElementById('result-creator-skin');
    const resultCreatorValue = document.getElementById('result-creator-value');
    const resultJoinerName = document.getElementById('result-joiner-name');
    const resultJoinerSkin = document.getElementById('result-joiner-skin');
    const resultJoinerValue = document.getElementById('result-joiner-value');
    const winnerInfo = document.getElementById('winner-info');
    const serverSeed = document.getElementById('server-seed');
    const resultClientSeed = document.getElementById('result-client-seed');
    const playAgainBtn = document.getElementById('play-again-btn');
    const historyTotalGames = document.getElementById('history-total-games');
    const historyGamesWon = document.getElementById('history-games-won');
    const historyGamesLost = document.getElementById('history-games-lost');
    const historyWinRate = document.getElementById('history-win-rate');
    const historyList = document.getElementById('history-list');
    const noHistory = document.getElementById('no-history');
    const addJoinSkinBtn = document.getElementById('add-join-skin-btn');
    const joinSelectedSkinsContainer = document.getElementById('join-selected-skins-container');
    const joinSelectedSkinsList = document.getElementById('join-selected-skins-list');
    const joinSelectedSkinsTotalValue = document.getElementById('join-selected-skins-total-value');
    const creatorSkinsList = document.getElementById('creator-skins-list');
    const multipleBetsInfo = document.getElementById('multiple-bets-info');
    const joinValueIndicator = document.getElementById('join-value-indicator');
    let joinSelectedSkins = [];
    const creatorSkinImg = document.querySelector('.creator-card .result-skin-img');
    const joinerSkinImg = document.querySelector('.joiner-card .result-skin-img');
    const addSkinBtn = document.getElementById('add-skin-btn');
    const selectedSkinsContainer = document.getElementById('selected-skins-container');
    const selectedSkinsList = document.getElementById('selected-skins-list');
    const selectedSkinsTotalValue = document.getElementById('selected-skins-total-value');
    let selectedSkins = [];

    if (!skinPreview) {
      skinPreview = document.createElement('div');
      skinPreview.id = 'skin-preview';
      skinPreview.style.display = 'none';
      skinPreview.style.marginTop = '12px';
      skinPreview.style.padding = '16px';
      skinPreview.style.backgroundColor = 'var(--bg-light)';
      skinPreview.style.borderRadius = '8px';
      const previewContent = document.createElement('div');
      previewContent.style.display = 'flex';
      previewContent.style.gap = '12px';
      skinImage = document.createElement('img');
      skinImage.id = 'skin-image';
      skinImage.style.width = '80px';
      skinImage.style.height = '80px';
      skinImage.style.borderRadius = '6px';
      skinImage.style.objectFit = 'cover';
      const detailsDiv = document.createElement('div');
      skinName = document.createElement('div');
      skinName.id = 'skin-name';
      skinName.style.fontWeight = '500';
      skinName.style.marginBottom = '4px';
      const rarityValueDiv = document.createElement('div');
      rarityValueDiv.style.display = 'flex';
      rarityValueDiv.style.gap = '8px';
      rarityValueDiv.style.marginBottom = '4px';
      skinRarity = document.createElement('span');
      skinRarity.id = 'skin-rarity';
      skinRarity.className = 'badge bg-secondary';
      skinValue = document.createElement('span');
      skinValue.id = 'skin-value';
      skinValue.style.color = 'var(--text-muted)';
      rarityValueDiv.appendChild(skinRarity);
      rarityValueDiv.appendChild(skinValue);
      detailsDiv.appendChild(skinName);
      detailsDiv.appendChild(rarityValueDiv);
      previewContent.appendChild(skinImage);
      previewContent.appendChild(detailsDiv);
      skinPreview.appendChild(previewContent);
      const formGroup = document.querySelector('#create-game-form .form-group');
      if (formGroup) {
        formGroup.insertBefore(skinPreview, betSkinSelect);
      }
    }

    if (!joinSkinPreview) {
      joinSkinPreview = document.createElement('div');
      joinSkinPreview.id = 'join-skin-preview';
      joinSkinPreview.style.display = 'none';
      joinSkinPreview.style.marginTop = '12px';
      joinSkinPreview.style.padding = '16px';
      joinSkinPreview.style.backgroundColor = 'var(--bg-light)';
      joinSkinPreview.style.borderRadius = '8px';
      const previewContent = document.createElement('div');
      previewContent.style.display = 'flex';
      previewContent.style.gap = '12px';
      joinSkinImage = document.createElement('img');
      joinSkinImage.id = 'join-skin-image';
      joinSkinImage.style.width = '80px';
      joinSkinImage.style.height = '80px';
      joinSkinImage.style.borderRadius = '6px';
      joinSkinImage.style.objectFit = 'cover';
      const detailsDiv = document.createElement('div');
      joinSkinName = document.createElement('div');
      joinSkinName.id = 'join-skin-name';
      joinSkinName.style.fontWeight = '500';
      joinSkinName.style.marginBottom = '4px';
      const rarityValueDiv = document.createElement('div');
      rarityValueDiv.style.display = 'flex';
      rarityValueDiv.style.gap = '8px';
      rarityValueDiv.style.marginBottom = '4px';
      joinSkinRarity = document.createElement('span');
      joinSkinRarity.id = 'join-skin-rarity';
      joinSkinRarity.className = 'badge bg-secondary';
      joinSkinValue = document.createElement('span');
      joinSkinValue.id = 'join-skin-value';
      joinSkinValue.style.color = 'var(--text-muted)';
      rarityValueDiv.appendChild(joinSkinRarity);
      rarityValueDiv.appendChild(joinSkinValue);
      detailsDiv.appendChild(joinSkinName);
      detailsDiv.appendChild(rarityValueDiv);
      previewContent.appendChild(joinSkinImage);
      previewContent.appendChild(detailsDiv);
      joinSkinPreview.appendChild(previewContent);
      const joinSkinDiv = joinSkinSelect.closest('div').parentNode;
      if (joinSkinDiv) {
        joinSkinDiv.appendChild(joinSkinPreview);
      }
    }

    function addSelectedSkin() {
  const selectedOption = betSkinSelect.options[betSkinSelect.selectedIndex];
  if (!selectedOption.value) return;
  
  const skinName = selectedOption.value;
  
  const alreadySelectedCount = selectedSkins.filter(skin => skin.name === skinName).length;
  
  const inventoryCount = userInventory.filter(s => s === skinName).length;
  
  if (alreadySelectedCount >= inventoryCount) {
    showError(createGameError, `You only have ${inventoryCount} copy/copies of ${skinName} in your inventory`);
    return;
  }
  
  const skinDetails = allSkins.find(skin => skin.name === skinName) || {
    name: skinName,
    value: parseInt(selectedOption.dataset.value || 0),
    rarity: selectedOption.dataset.rarity || 'Common',
    image_url: selectedOption.dataset.image || ''
  };
  
  selectedSkins.push(skinDetails);
  updateSelectedSkinsUI();
  betSkinSelect.value = '';
  if (skinPreview) skinPreview.style.display = 'none';
}
function initWagerTracker() {
  if (!localStorage.getItem('wagered_games')) {
    localStorage.setItem('wagered_games', JSON.stringify([]));
  }
}


async function updateUserRank(gameData) {
  console.log("gobumm")
}



function showGameResultNotification(game, userRole) {
      if (!game || !game.winner) return;
      
      const isWinner = game.winner.discordId === user.discordId;
      const opponent = userRole === 'creator' ? game.joiner.robloxUsername : game.creator.robloxUsername;
      const skinsList = Array.isArray(game.winner.skins) ? game.winner.skins.join(', ') : game.winner.skins;
      
      const creatorValue = game.creator.skinValue || game.creator.skinsValue || 0;
      const joinerValue = game.joiner.skinValue || game.joiner.skinsValue || 0;
      const totalValue = creatorValue + joinerValue;
      
      if (isWinner) {
        showNotification(
          '🎉 You Won!',
          `You won against ${opponent} and received all skins (total value: ${formatValue(totalValue)})!`,
          'View Details',
          () => showGameResult(game)
        );
      } else {
        showNotification(
          '😞 You Lost',
          `You lost to ${opponent}. Better luck next time!`,
          'View Details',
          () => showGameResult(game)
        );
      }
    }
    

    function addJoinSelectedSkin() {
      const selectedOption = joinSkinSelect.options[joinSkinSelect.selectedIndex];
      if (!selectedOption.value) return;
      const skinName = selectedOption.value;
      
      const selectedCount = joinSelectedSkins.filter(s => s.name === skinName).length;
      
      const inventoryCount = userInventory.filter(s => s === skinName).length;
      
      if (selectedCount >= inventoryCount) {
        showError(joinGameError, `You've already selected all available copies of ${skinName}`);
        return;
      }
      
      const skinDetails = allSkins.find(skin => skin.name === skinName) || {
        name: skinName,
        value: parseInt(selectedOption.dataset.value || 0),
        rarity: selectedOption.dataset.rarity || 'Common',
        image_url: selectedOption.dataset.image || ''
      };
      
      joinSelectedSkins.push(skinDetails);
      updateJoinSelectedSkinsUI();
      joinSkinSelect.value = '';
      if (joinSkinPreview) joinSkinPreview.style.display = 'none';
    }

    function updateJoinSelectedSkinsUI() {
      if (joinSelectedSkins.length === 0) {
        joinSelectedSkinsContainer.style.display = 'none';
        return;
      }
      
      joinSelectedSkinsContainer.style.display = 'block';
      joinSelectedSkinsList.innerHTML = '';
      
      const skinCounts = {};
      joinSelectedSkins.forEach(skin => {
        skinCounts[skin.name] = (skinCounts[skin.name] || 0) + 1;
      });
      
      const uniqueSkins = [];
      let totalValue = 0;
      
      joinSelectedSkins.forEach(skin => {
        totalValue += skin.value;
        
        if (!uniqueSkins.some(s => s.name === skin.name)) {
          uniqueSkins.push(skin);
        }
      });
      
      uniqueSkins.forEach(skin => {
        const count = skinCounts[skin.name];
        const skinItem = document.createElement('div');
        skinItem.style.display = 'flex';
        skinItem.style.alignItems = 'center';
        skinItem.style.justifyContent = 'space-between';
        skinItem.style.padding = '8px';
        skinItem.style.backgroundColor = '#1a2234';
        skinItem.style.borderRadius = '4px';
        skinItem.style.marginBottom = '8px';
        
        const countBadge = count > 1 ? 
          `<span style="background-color: #334155; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 6px;">${count}x</span>` 
          : '';
        
        skinItem.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 32px; height: 32px; border-radius: 4px; overflow: hidden; background-color: #334155;">
              <img src="${skin.image_url || 'https://via.placeholder.com/32'}" alt="${skin.name}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div>
              <div style="font-weight: 500; color: #f8fafc; display: flex; align-items: center;">
                ${skin.name} ${countBadge}
              </div>
              <div style="font-size: 12px; color: #94a3b8;">${formatValue(skin.value * count)} value (${formatValue(skin.value)} each)</div>
            </div>
          </div>
          <button type="button" class="remove-all-join-skin-btn" data-name="${skin.name}" style="background: transparent; border: none; color: #94a3b8; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        joinSelectedSkinsList.appendChild(skinItem);
      });
      
      joinSelectedSkinsTotalValue.textContent = formatValue(totalValue);
      
      document.querySelectorAll('.remove-all-join-skin-btn').forEach(button => {
        button.addEventListener('click', () => {
          const skinName = button.getAttribute('data-name');
          joinSelectedSkins = joinSelectedSkins.filter(skin => skin.name !== skinName);
          updateJoinSelectedSkinsUI();
          
          const game = activeGames.find(g => g.gameId === selectedGameId);
          if (game) {
            filterJoinSkinOptions(game.skinValue, game.allowMultipleBets);
          }
        });
      });
      
      updateValueIndicator();
    }
    
    function updateValueIndicator() {
      const game = activeGames.find(g => g.gameId === selectedGameId);
      if (!game || !joinValueIndicator) return;
      
      const totalSelectedValue = joinSelectedSkins.reduce((sum, skin) => sum + skin.value, 0);
      const requiredValue = game.skinValue;
      const valueDifference = requiredValue - totalSelectedValue;
      
      joinValueIndicator.style.display = 'block';
      
      if (totalSelectedValue >= requiredValue) {
        joinValueIndicator.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
            <i class="fas fa-check-circle" style="color: var(--success);"></i>
            <span>Value requirement met (${formatValue(totalSelectedValue)} / ${formatValue(requiredValue)})</span>
          </div>
        `;
        joinValueIndicator.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
        joinValueIndicator.style.borderLeft = '3px solid var(--success)';
      } else {
        joinValueIndicator.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
            <i class="fas fa-exclamation-circle" style="color: var(--warning);"></i>
            <span>Need ${formatValue(valueDifference)} more value (${formatValue(totalSelectedValue)} / ${formatValue(requiredValue)})</span>
          </div>
        `;
        joinValueIndicator.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
        joinValueIndicator.style.borderLeft = '3px solid var(--warning)';
      }
    }

    function updateSelectedSkinsUI() {
      if (selectedSkins.length === 0) {
        selectedSkinsContainer.style.display = 'none';
        return;
      }
      
      selectedSkinsContainer.style.display = 'block';
      selectedSkinsList.innerHTML = '';
      
      const skinCounts = {};
      selectedSkins.forEach(skin => {
        skinCounts[skin.name] = (skinCounts[skin.name] || 0) + 1;
      });
      
      const uniqueSkins = [];
      let totalValue = 0;
      
      selectedSkins.forEach(skin => {
        totalValue += skin.value;
        
        if (!uniqueSkins.some(s => s.name === skin.name)) {
          uniqueSkins.push(skin);
        }
      });
      
      uniqueSkins.forEach(skin => {
        const count = skinCounts[skin.name];
        const skinItem = document.createElement('div');
        skinItem.className = 'selected-skin-item';
        skinItem.style.display = 'flex';
        skinItem.style.alignItems = 'center';
        skinItem.style.justifyContent = 'space-between';
        skinItem.style.padding = '8px 12px';
        skinItem.style.backgroundColor = 'var(--bg-light)';
        skinItem.style.borderRadius = '6px';
        skinItem.style.marginBottom = '8px';
        
        const countBadge = count > 1 ? 
          `<span style="background-color: var(--bg-dark); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 6px;">${count}x</span>` 
          : '';
        
        skinItem.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 32px; height: 32px; border-radius: 4px; overflow: hidden;">
              <img src="${skin.image_url || 'https://via.placeholder.com/32'}" alt="${skin.name}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div>
              <div style="font-weight: 500; display: flex; align-items: center;">
                ${skin.name} ${countBadge}
              </div>
              <div style="font-size: 12px; color: var(--text-muted);">${formatValue(skin.value * count)} value (${formatValue(skin.value)} each)</div>
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-outline remove-all-skin-btn" data-name="${skin.name}" style="padding: 4px 8px;">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        selectedSkinsList.appendChild(skinItem);
      });
      
      selectedSkinsTotalValue.textContent = formatValue(totalValue);
      
      document.querySelectorAll('.remove-all-skin-btn').forEach(button => {
        button.addEventListener('click', () => {
          const skinName = button.getAttribute('data-name');
          selectedSkins = selectedSkins.filter(skin => skin.name !== skinName);
          updateSelectedSkinsUI();
        });
      });
    }

    let user = null;
    let activeGames = [];
    let recentGames = [];
    let selectedGameId = null;
    let userHistory = [];
    let userInventory = [];
    let allSkins = [];
    let userInventoryStats = null;

    function formatValue(value) {
        return value?.toLocaleString() || '0';
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function getRarityColor(rarity) {
        const colors = {
            'common': 'secondary',
            'uncommon': 'success',
            'rare': 'primary',
            'epic': 'purple',
            'legendary': 'warning',
            'mythic': 'danger'
        };
        return colors[rarity?.toLowerCase()] || 'secondary';
    }

    function generateRandomSeed() {
        return Math.random().toString(36).substring(2, 15) +
               Math.random().toString(36).substring(2, 15);
    }

    function showError(element, message) {
        element.textContent = message;
        element.style.display = 'block';
        element.classList.add('shake');
        setTimeout(() => {
            element.classList.remove('shake');
        }, 500);
    }

    function hideError(element) {
        element.style.display = 'none';
        element.textContent = '';
    }

    function showLoading(element) {
        element.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div> Loading...';
        element.disabled = true;
    }

    function hideLoading(element, text) {
        element.innerHTML = text;
        element.disabled = false;
    }

    async function fetchAndCacheSkin(skinName) {
      if (!skinName) {
        console.warn("Attempted to fetch undefined skin");
        return null;
      }
      
      try {
        const cachedSkin = allSkins.find(skin => skin.name === skinName);
        if (cachedSkin) {
          return cachedSkin;
        }
        const response = await fetch(`${api}/skin/${encodeURIComponent(skinName)}`);
        if (!response.ok) {
          console.warn(`Failed to fetch skin "${skinName}": ${response.status}`);
          return null;
        }
        const skinData = await response.json();
        allSkins.push(skinData);
        return skinData;
      } catch (error) {
        console.error(`Error fetching skin "${skinName}":`, error);
        return null;
      }
    }

    async function fetchPendingApprovals() {
      if (!user) return [];
      try {
        const token = AuthClient.getToken();
        const response = await fetch(`${api}/coinflip/pending-approvals/${user.discordId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!response.ok) {
          if (response.status === 401) {
            AuthClient.logout();
            return [];
          }
          throw new Error('Failed to fetch pending approvals');
        }
        const data = await response.json();
        return data.pendingGames || [];
      } catch (error) {
        console.error('Error fetching pending approvals:', error);
        return [];
      }
    }

    async function handleGameApproval(gameId, approve) {
      if (!user) return;
      try {
        const token = AuthClient.getToken();
        const response = await fetch(`${api}/coinflip/approve/${gameId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            discordId: user.discordId,
            approved: approve
          })
        });
        if (!response.ok) {
          throw new Error('Failed to process approval');
        }
        const result = await response.json();
        if (approve) {
          showGameResult(result);
        } else {
          showNotification(
            'Game Rejected',
            'You have rejected the game. The joiner\'s skins have been returned.',
            'OK',
            () => {}
          );
        }
        await Promise.all([
          fetchActiveGames(),
          fetchRecentGames(),
          fetchUserInventory(),
          fetchUserHistory(),
          fetchInventoryStats(),
          fetchStats()
        ]);
      } catch (error) {
        console.error('Error handling game approval:', error);
        showNotification(
          'Error',
          'Failed to process your request. Please try again later.',
          'OK',
          () => {}
        );
      }
    }

    function renderPendingApprovals(pendingGames) {
      if (!pendingGames || pendingGames.length === 0) return;
      const pendingApprovalsSection = document.createElement('div');
      pendingApprovalsSection.className = 'card';
      pendingApprovalsSection.style.marginBottom = '24px';
      pendingApprovalsSection.innerHTML = `
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-exclamation-circle" style="color: var(--warning);"></i>
            Pending Approvals (${pendingGames.length})
          </h3>
        </div>
        <div class="card-body">
          <p>The following games require your approval because the joiner is betting different skins than yours:</p>
          <div id="pending-approvals-list" style="margin-top: 16px;"></div>
        </div>
      `;
      const gamesContent = document.getElementById('games-content');
      gamesContent.insertBefore(pendingApprovalsSection, gamesContent.firstChild);
      const pendingApprovalsList = document.getElementById('pending-approvals-list');
      pendingGames.forEach(game => {
        const pendingGameCard = document.createElement('div');
        pendingGameCard.className = 'game-card';
        pendingGameCard.style.marginBottom = '16px';
        const creatorSkins = Array.isArray(game.creator.skins) ? game.creator.skins.join(', ') : game.creator.skins;
        const joinerSkins = Array.isArray(game.joiner.skins) ? game.joiner.skins.join(', ') : game.joiner.skins;
        pendingGameCard.innerHTML = `
          <div class="game-header">
            <div class="game-creator">
              <div class="creator-avatar">${game.joiner.robloxUsername.charAt(0)}</div>
              <div>${game.joiner.robloxUsername} wants to join your game</div>
            </div>
            <div class="game-status" style="background-color: rgba(245, 158, 11, 0.15); color: var(--warning);">Pending Approval</div>
          </div>
          <div class="game-body">
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; margin-bottom: 8px;">Your Bet:</div>
              <div style="background-color: var(--bg-light); padding: 12px; border-radius: 8px;">
                ${creatorSkins} (${formatValue(game.creator.skinValue)} value)
              </div>
            </div>
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; margin-bottom: 8px;">Joiner's Bet:</div>
              <div style="background-color: var(--bg-light); padding: 12px; border-radius: 8px;">
                ${joinerSkins} (${formatValue(game.joiner.skinValue)} value)
              </div>
            </div>
            <div class="game-actions">
              <button class="btn btn-success approve-game-btn" data-game-id="${game.gameId}">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="btn btn-danger reject-game-btn" data-game-id="${game.gameId}">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          </div>
        `;
        pendingApprovalsList.appendChild(pendingGameCard);
      });
      document.querySelectorAll('.approve-game-btn').forEach(button => {
        button.addEventListener('click', () => {
          const gameId = button.getAttribute('data-game-id');
          handleGameApproval(gameId, true);
        });
      });
      document.querySelectorAll('.reject-game-btn').forEach(button => {
        button.addEventListener('click', () => {
          const gameId = button.getAttribute('data-game-id');
          handleGameApproval(gameId, false);
        });
      });
    }

    async function fetchActiveGames() {
      try {
        gamesLoading.style.display = 'block';
        noGamesMessage.style.display = 'none';
        activeGamesList.innerHTML = '';
        const response = await fetch(`${api}/coinflip/active`);
        if (!response.ok) throw new Error('Failed to fetch active games');
        const data = await response.json();
        activeGames = data.games || [];
        const skinPromises = activeGames.map(game => fetchAndCacheSkin(Array.isArray(game.betSkins) ? game.betSkins[0] : game.betSkins));
        await Promise.allSettled(skinPromises);
        renderActiveGames();
      } catch (error) {
        console.error('Error fetching active games:', error);
        showNoGames('Error loading games. Please try again later.');
      } finally {
        gamesLoading.style.display = 'none';
      }
    }

    async function fetchRecentGames() {
        try {
            const response = await fetch(`${api}/coinflip/recent`);
            if (!response.ok) throw new Error('Failed to fetch recent games');
            const data = await response.json();
            recentGames = data.games || [];
            renderRecentGames();
        } catch (error) {
            console.error('Error fetching recent games:', error);
            noRecentGames.textContent = 'Error loading recent games. Please try again later.';
            noRecentGames.style.display = 'block';
        }
    }

    async function fetchSkins() {
        try {
            const response = await fetch(`${api}/skins`);
            if (!response.ok) throw new Error('Failed to fetch skins');
            const data = await response.json();
            allSkins = data.skins || [];
        } catch (error) {
            console.error('Error fetching skins:', error);
        }
    }

    async function fetchLeaderboard() {
        try {
            const response = await fetch(`${api}/coinflip/leaderboard`);
            if (!response.ok) throw new Error('Failed to fetch leaderboard');
            const data = await response.json();
            const leaderboard = data.leaderboard || [];
            renderLeaderboard(leaderboard);
        } catch (error) {
            console.error('Error fetching leaderboard:', error);
            noLeaderboard.textContent = 'Error loading leaderboard. Please try again later.';
            noLeaderboard.style.display = 'block';
        }
    }

    async function fetchStats() {
        try {
            const response = await fetch(`${api}/coinflip/stats`);
            if (!response.ok) throw new Error('Failed to fetch stats');
            const data = await response.json();
            totalGamesElement.textContent = formatValue(data.totalGames || 0);
            totalValueElement.textContent = formatValue(data.totalValueGambled || 0);
            if (data.biggestWin) {
                biggestWinElement.textContent = `${data.biggestWin.winner.robloxUsername} (${formatValue(data.biggestWin.winValue)})`;
            } else {
                biggestWinElement.textContent = 'None yet';
            }
            if (data.mostActivePlayer) {
                topPlayerElement.textContent = `${data.mostActivePlayer.robloxUsername} (${data.mostActivePlayer.gameCount} games)`;
            } else {
                topPlayerElement.textContent = 'None yet';
            }
        } catch (error) {
            console.error('Error fetching stats:', error);
        }
    }

    async function fetchUserInventory() {
        if (!user) return;
        try {
            const token = AuthClient.getToken();
            const response = await fetch(`${api}/inventory?discordId=${user.discordId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) {
                    AuthClient.logout();
                    return;
                }
                throw new Error('Failed to fetch inventory');
            }
            const data = await response.json();
            userInventory = data.skins || [];
            updateSkinSelects();
        } catch (error) {
            console.error('Error fetching user inventory:', error);
        }
    }

    async function fetchInventoryStats() {
        if (!user) return;
        try {
            const token = AuthClient.getToken();
            const response = await fetch(`${api}/inventory/stats/${user.discordId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) {
                    AuthClient.logout();
                    return;
                }
                throw new Error('Failed to fetch inventory stats');
            }
            userInventoryStats = await response.json();
            if (userInventoryValue) {
                userInventoryValue.textContent = formatValue(userInventoryStats.totalValue || 0);
            }
        } catch (error) {
            console.error('Error fetching inventory stats:', error);
        }
    }

    async function fetchUserHistory() {
        if (!user) return;
        try {
            const token = AuthClient.getToken();
            const response = await fetch(`${api}/coinflip/history/${user.discordId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) {
                    AuthClient.logout();
                    return;
                }
                throw new Error('Failed to fetch history');
            }
            const data = await response.json();
            userHistory = data.games || [];
            if (data.stats) {
                if (userGamesPlayed) userGamesPlayed.textContent = data.stats.totalGames || 0;
                if (userGamesWon) userGamesWon.textContent = data.stats.gamesWon || 0;
                if (userWinRate) {
                    const winRate = data.stats.totalGames > 0
                        ? Math.round((data.stats.gamesWon / data.stats.totalGames) * 100)
                        : 0;
                    userWinRate.textContent = `${winRate}%`;
                }
            }
        } catch (error) {
            console.error('Error fetching user history:', error);
        }
    }

    async function createGame(skinNames) {
      if (!user) return;
      try {
        showLoading(createGameSubmitBtn);
        hideError(createGameError);
        
        const allowMultipleBets = document.getElementById('allow-multiple-bets')?.checked || false;
        
        const token = AuthClient.getToken();
        const response = await fetch(`${api}/coinflip/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            discordId: user.discordId,
            robloxUsername: user.robloxUsername,
            betSkins: skinNames,
            allowMultipleBets: allowMultipleBets
          })
        });
        
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Failed to create game');
        }
        
        createGameModal.hide();
        await fetchActiveGames();
        await fetchUserInventory();
        selectedSkins = [];
        updateSelectedSkinsUI();
        
        showNotification(
          'Game Created',
          `Game created successfully with ${skinNames.length} skin${skinNames.length > 1 ? 's' : ''}!`,
          'View Games',
          () => {
            const title = document.querySelector('.section-title');
            if (title) title.scrollIntoView({ behavior: 'smooth' });
          }
        );
      } catch (error) {
        console.error('Error creating game:', error);
        showError(createGameError, error.message);
      } finally {
        hideLoading(createGameSubmitBtn, 'Create Game');
      }
    }

    async function joinGame(gameId, skinNames, clientSeed) {
  if (!user) return;
  try {
    showLoading(joinGameSubmitBtn);
    hideError(joinGameError);
    const token = AuthClient.getToken();
    const response = await fetch(`${api}/coinflip/join/${gameId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        discordId: user.discordId,
        robloxUsername: user.robloxUsername,
        betSkins: skinNames,
        clientSeed: clientSeed || undefined
      })
    });
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || 'Failed to join game');
    }
    joinGameModal.hide();
    
    if (data.status === 'pending_approval') {
      showNotification(
        'Waiting for Approval',
        'Your bet requires approval from the creator because you\'re betting different skins.',
        'OK',
        () => {}
      );
      await Promise.all([
        fetchActiveGames(),
        fetchUserInventory()
      ]);
      return;
    }

    showGameResult(data);
    await Promise.all([
      fetchActiveGames(),
      fetchRecentGames(),
      fetchUserInventory(),
      fetchUserHistory(),
      fetchInventoryStats(),
      fetchStats()
    ]);
    
    joinSelectedSkins = [];
    updateJoinSelectedSkinsUI();
  } catch (error) {
    console.error('Error joining game:', error);
    showError(joinGameError, error.message);
  } finally {
    hideLoading(joinGameSubmitBtn, 'Join Game');
  }
}

    async function fetchSkinDetails(skinName) {
        if (!skinName) {
          console.warn("Attempted to fetch details for undefined skin");
          return null;
        }
        
        try {
          const response = await fetch(`${api}/skin/${encodeURIComponent(skinName)}`);
          if (!response.ok) {
            console.warn(`Failed to fetch details for skin ${skinName}: ${response.status}`);
            return null;
          }
          const skinDetails = await response.json();
          return skinDetails;
        } catch (error) {
          console.error(`Error fetching details for skin ${skinName}:`, error);
          return null;
        }
    }

    async function cancelGame(gameId) {
  if (!user) return;
  try {
    const token = AuthClient.getToken();
    
    const gameResponse = await fetch(`${api}/coinflip/game/${gameId}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!gameResponse.ok) {
      throw new Error('Failed to fetch game details');
    }
    
    const gameDetails = await gameResponse.json();
    const hasJoiner = gameDetails.joiner && gameDetails.joiner.discordId;
    const joinerDiscordId = hasJoiner ? gameDetails.joiner.discordId : null;
    
    const response = await fetch(`${api}/coinflip/cancel/${gameId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        discordId: user.discordId,
        notifyJoiner: hasJoiner
      })
    });
    
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || 'Failed to cancel game');
    }
    
    await Promise.all([
      fetchActiveGames(),
      fetchUserHistory(),
      fetchUserInventory()
    ]);
    
    showNotification(
      'Game Cancelled',
      'Your game has been cancelled and your skins have been returned to your inventory.',
      'OK',
      () => {}
    );
  } catch (error) {
    console.error('Error cancelling game:', error);
    showNotification(
      'Error',
      `Failed to cancel game: ${error.message}`,
      'OK',
      () => {}
    );
  }
}

    async function updateAuthUI() {
      try {
        user = await AuthClient.getCurrentUser();
        if (user) {

          if (userInfo) userInfo.style.display = 'flex';
          if (loginBtn) loginBtn.style.display = 'none';
          if (usernameDisplay) usernameDisplay.textContent = user.robloxUsername;
          if (userAvatar) userAvatar.textContent = user.robloxUsername.charAt(0).toUpperCase();
          if (loginRequiredCard) {
            loginRequiredCard.style.display = 'none';
          }
          if (gamesContent) {
            gamesContent.style.display = 'block';
          }
          if (userPanel) {
            userPanel.style.display = 'block';
            if (profileUsername) {
              profileUsername.textContent = user.robloxUsername;
            }
            if (profileDiscordId) {
              profileDiscordId.textContent = user.discordId;
            }
          }
          await cleanupOldNotifications();
          const promises = [];
          if (typeof fetchUserInventory === 'function') promises.push(fetchUserInventory());
          if (typeof fetchUserHistory === 'function') promises.push(fetchUserHistory());
          if (typeof fetchInventoryStats === 'function') promises.push(fetchInventoryStats());
          if (promises.length > 0) {
            await Promise.all(promises);
          }
        } else {
          if (userInfo) userInfo.style.display = 'none';
          if (loginBtn) loginBtn.style.display = 'flex';
          if (loginRequiredCard) {
            loginRequiredCard.style.display = 'block';
          }
          if (gamesContent) {
            gamesContent.style.display = 'none';
          }
          if (userPanel) {
            userPanel.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error updating auth UI:', error);
      }
    }

    function showNotification(title, message, actionText, actionCallback) {
      const notification = document.getElementById('game-notification');
      const notificationTitle = document.getElementById('notification-title');
      const notificationMessage = document.getElementById('notification-message');
      const notificationAction = document.getElementById('notification-action');
      const notificationDismiss = document.getElementById('notification-dismiss');
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      notificationAction.textContent = actionText || 'View';
      notificationAction.onclick = () => {
        if (typeof actionCallback === 'function') {
          actionCallback();
        }
        notification.classList.remove('show');
      };
      notificationDismiss.onclick = () => {
        notification.classList.remove('show');
      };
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 15000);
    }


    async function checkForRejectedJoins() {
      if (!user) return;
      
      try {
        const response = await fetch(`${api}/coinflip/history/${user.discordId}?recent=true`);
        if (!response.ok) return;
        
        const data = await response.json();
        const recentlyRejectedGames = data.games?.filter(game => 
          game.status === 'rejected' && 
          game.role === 'joiner' &&
          new Date(game.updatedAt || game.joinedAt) > new Date(Date.now() - 30000) 
        ) || [];
        
        if (recentlyRejectedGames.length > 0) {
          const viewedRejections = JSON.parse(localStorage.getItem('viewed_rejections') || '[]');
          const unviewedRejections = recentlyRejectedGames.filter(game => !viewedRejections.includes(game.gameId));
          
          if (unviewedRejections.length > 0) {
            const gameToShow = unviewedRejections[0];
            viewedRejections.push(gameToShow.gameId);
            localStorage.setItem('viewed_rejections', JSON.stringify(viewedRejections));
            
            showNotification(
              '❌ Join Request Rejected',
              `Your request to join ${gameToShow.creator.robloxUsername}'s game was rejected. Your skins have been returned to your inventory.`,
              'OK',
              () => {}
            );
            
            fetchUserInventory();
            fetchActiveGames();
          }
        }
      } catch (error) {
        console.error('Error checking for rejected joins:', error);
      }
    }




    async function cleanupOldNotifications() {
  if (!user) return;
  
  try {
    console.log(`Cleaning up old notifications for user ${user.discordId}`);
    const token = AuthClient.getToken();
    
    const response = await fetch(`${api}/notifications?unread=true`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      console.error('Failed to fetch notifications for cleanup');
      return;
    }
    
    const data = await response.json();
    if (!data.notifications || data.notifications.length === 0) {
      console.log('No old notifications to clean up');
      return;
    }
    
    console.log(`Found ${data.notifications.length} old notifications to mark as read`);
    
    for (const notification of data.notifications) {
      await fetch(`${api}/notifications/${notification.id}/read`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
    }
    
    console.log('Successfully cleaned up old notifications');
  } catch (error) {
    console.error('Error cleaning up old notifications:', error);
  }
}



    async function checkForNotifications() {
  if (!user) return;
  
  try {
    const token = AuthClient.getToken();
    const response = await fetch(`${api}/notifications?unread=true`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) return;
    
    const data = await response.json();
    console.log(`Received ${data.notifications?.length || 0} notifications for user ${user.discordId}`);
    
    if (!data.notifications || data.notifications.length === 0) {
      return;
    }
    
    const latestNotification = data.notifications[0];
    console.log(`Processing latest notification: ${latestNotification.type} (ID: ${latestNotification.id})`);
    
    for (const notification of data.notifications) {
      try {
        await fetch(`${api}/notifications/${notification.id}/read`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        console.log(`Marked notification ${notification.id} as read`);
      } catch (markError) {
        console.error(`Failed to mark notification ${notification.id} as read:`, markError);
      }
    }
    
    if (latestNotification.type === 'game_rejected') {
      showNotification(
        '❌ Join Request Rejected',
        latestNotification.content,
        'OK',
        () => {
          fetchUserInventory();
        }
      );
    } else if (latestNotification.type === 'game_won') {
      showNotification(
        '🏆 You Won!',
        latestNotification.content,
        'View Details',
        async () => {
          if (latestNotification.reference_id) {
            const gameResponse = await fetch(`${api}/coinflip/game/${latestNotification.reference_id}`);
            if (gameResponse.ok) {
              const gameData = await gameResponse.json();
              showGameResult(gameData);
            }
          }
          fetchUserInventory();
        }
      );
    } else if (latestNotification.type === 'game_lost') {
      showNotification(
        '😞 You Lost',
        latestNotification.content,
        'View Details',
        async () => {
          if (latestNotification.reference_id) {
            const gameResponse = await fetch(`${api}/coinflip/game/${latestNotification.reference_id}`);
            if (gameResponse.ok) {
              const gameData = await gameResponse.json();
              showGameResult(gameData);
            }
          }
          fetchUserInventory();
        }
      );
    } else if (latestNotification.type === 'game_cancelled') {
      showNotification(
        '❌ Game Cancelled',
        latestNotification.content,
        'OK',
        () => {
          fetchUserInventory();
        }
      );
    }
  } catch (error) {
    console.error('Error checking for notifications:', error);
  }
}





    async function checkForNewJoins() {
      if (!user) return;
      try {
        const response = await fetch(`${api}/coinflip/history/${user.discordId}?recent=true`);
        if (!response.ok) return;
        const data = await response.json();
        const completedGames = data.games?.filter(game =>
          game.status === 'completed' &&
          game.role === 'creator'
        ) || [];
        if (completedGames.length > 0) {
          const latestGame = completedGames[0];
          const viewedGames = JSON.parse(localStorage.getItem('viewed_games') || '[]');
          if (!viewedGames.includes(latestGame.gameId)) {
            viewedGames.push(latestGame.gameId);
            localStorage.setItem('viewed_games', JSON.stringify(viewedGames));
            showGameResult(latestGame);
          }
        }
      } catch (error) {
        console.error('Error checking for completed games:', error);
      }
    }


    

    async function pollCompletedGames() {
  if (!user) return;
  try {
    const currentTime = Date.now();
    const lastPollTime = parseInt(localStorage.getItem('last_game_poll_time') || '0');
    if (currentTime - lastPollTime < 2500) {
      return;
    }
    localStorage.setItem('last_game_poll_time', currentTime.toString());
    
    const response = await fetch(`${api}/coinflip/history/${user.discordId}?recent=true`);
    if (!response.ok) return;
    
    const data = await response.json();
    const recentlyCompletedGames = data.games?.filter(game =>
      game.status === 'completed' &&
      new Date(game.completedAt) > new Date(Date.now() - 30000)
    ) || [];
    
    if (recentlyCompletedGames.length > 0) {
      const viewedGames = JSON.parse(localStorage.getItem('viewed_games') || '[]');
      
      for (const game of recentlyCompletedGames) {
        const gameDetailsResponse = await fetch(`${api}/coinflip/game/${game.gameId}`);
        if (gameDetailsResponse.ok) {
          const gameDetails = await gameDetailsResponse.json();
          
          let wagerAmount = 0;
          if (game.role === 'creator') {
            wagerAmount = gameDetails.creator.skinValue || gameDetails.creator.skinsValue || 
                          gameDetails.creatorSkinValue || 0;
          } else {
            wagerAmount = gameDetails.joiner.skinValue || gameDetails.joiner.skinsValue || 
                          gameDetails.joinerSkinValue || 0;
          }
          
          await updateUserRank({
            creator: gameDetails.creator,
            joiner: gameDetails.joiner,
            wagerAmount: wagerAmount,
            gameId: game.gameId
          });
          
          if (!viewedGames.includes(game.gameId) && game === recentlyCompletedGames[0]) {
            showGameResultNotification(gameDetails, game.role);
            
            viewedGames.push(game.gameId);
          }
        }
      }
      
      localStorage.setItem('viewed_games', JSON.stringify(viewedGames));
      
      await Promise.all([
        fetchActiveGames(),
        fetchRecentGames(),
        fetchUserInventory()
      ]);
    }
  } catch (error) {
    console.error('Error polling for game updates:', error);
  }
}

    async function pollActiveGames() {
      if (!user) return;
      try {
        const currentTime = Date.now();
        const lastPollTime = parseInt(localStorage.getItem('last_game_poll_time') || '0');
        if (currentTime - lastPollTime < 2500) {
          return;
        }
        localStorage.setItem('last_game_poll_time', currentTime.toString());
        const response = await fetch(`${api}/coinflip/history/${user.discordId}?recent=true`);
        if (!response.ok) return;
        const data = await response.json();
        const recentlyCompletedGames = data.games?.filter(game =>
          game.status === 'completed' &&
          game.role === 'creator'
        ) || [];
        if (recentlyCompletedGames.length > 0) {
          const viewedGames = JSON.parse(localStorage.getItem('viewed_games') || '[]');
          const unviewedGames = recentlyCompletedGames.filter(game => !viewedGames.includes(game.gameId));
          if (unviewedGames.length > 0) {
            const gameToShow = unviewedGames[0];
            viewedGames.push(gameToShow.gameId);
            localStorage.setItem('viewed_games', JSON.stringify(viewedGames));
            showGameResult(gameToShow);
          }
        }
      } catch (error) {
        console.error('Error polling for game updates:', error);
      }
    }

    function renderActiveGames() {
      activeGamesList.innerHTML = '';
      if (activeGames.length === 0) {
        noGamesMessage.style.display = 'block';
        return;
      }
      noGamesMessage.style.display = 'none';
      activeGames.forEach(game => {
        const gameElement = document.createElement('div');
        const betSkins = Array.isArray(game.betSkins) ? game.betSkins : [game.betSkin];
        const primarySkin = betSkins[0] || "Unknown Skin"; 
        const skinDetails = allSkins.find(skin => skin.name === primarySkin);
        const rarityClass = skinDetails ? getRarityColor(skinDetails.rarity) : 'secondary';
        const rarity = skinDetails?.rarity || 'Unknown';
        
        const multipleBetsIndicator = game.allowMultipleBets ? 
          `<div style="font-size: 12px; background-color: rgba(16, 185, 129, 0.15); color: var(--success); padding: 4px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; margin-top: 8px;">
            <i class="fas fa-check-circle"></i> Multiple lower-value skins allowed
          </div>` : '';
        
        gameElement.innerHTML = `
          <div class="game-card">
            <div class="game-header">
              <div class="game-creator">
                <div class="creator-avatar">${game.creator.robloxUsername.charAt(0)}</div>
                <div>${game.creator.robloxUsername}</div>
              </div>
              <div class="game-status">Active</div>
            </div>
            <div class="game-body">
              <div class="bet-item">
                <img src="https://via.placeholder.com/80?text=Loading..."
                    alt="${primarySkin}"
                    class="skin-image">
                <div class="skin-details">
                  <div class="skin-name">${primarySkin}</div>
                  <div class="skin-value">${formatValue(game.skinValue)} value</div>
                  <div class="skin-tag rarity-${rarity.toLowerCase()}">${rarity}</div>
                </div>
              </div>
              ${betSkins.length > 1 ? `<div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">+${betSkins.length - 1} more skin${betSkins.length > 2 ? 's' : ''}</div>` : ''}
              ${multipleBetsIndicator}
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px; margin-top: 8px;">
                <i class="far fa-clock"></i> ${formatDate(game.createdAt)}
              </div>
              <div class="game-actions">
                ${user && user.discordId === game.creator.discordId
                  ? `<button class="btn btn-danger cancel-game-btn" data-game-id="${game.gameId}">Cancel Game</button>`
                  : `<button class="btn btn-success join-game-btn" data-game-id="${game.gameId}">Join Game</button>`
                }
              </div>
            </div>
          </div>
        `;
        activeGamesList.appendChild(gameElement);
        const imageContainer = gameElement.querySelector('.skin-image');
        if (imageContainer) {
          loadSkinImage(primarySkin, imageContainer);
        }
      });
      document.querySelectorAll('.join-game-btn').forEach(button => {
        button.addEventListener('click', () => {
          const gameId = button.getAttribute('data-game-id');
          openJoinGameModal(gameId);
        });
      });
      document.querySelectorAll('.cancel-game-btn').forEach(button => {
        button.addEventListener('click', () => {
          const gameId = button.getAttribute('data-game-id');
          if (confirm('Are you sure you want to cancel this game?')) {
            cancelGame(gameId);
          }
        });
      });
    }

    async function loadSkinImage(skinName, imageElement) {
      if (!skinName) {
        imageElement.src = 'https://via.placeholder.com/80?text=No+Image';
        return;
      }
      
      imageElement.src = 'https://via.placeholder.com/80?text=Loading...';
      try {
        const skinDetails = allSkins.find(skin => skin.name === skinName);
        if (skinDetails && skinDetails.image_url) {
          imageElement.src = skinDetails.image_url;
        } else {
          const response = await fetch(`${api}/skin/${encodeURIComponent(skinName)}`);
          if (response.ok) {
            const data = await response.json();
            if (data && data.image_url) {
              imageElement.src = data.image_url;
              if (!allSkins.some(s => s.name === skinName)) {
                allSkins.push(data);
              }
            } else {
              imageElement.src = 'https://via.placeholder.com/80?text=No+Image';
            }
          } else {
            imageElement.src = 'https://via.placeholder.com/80?text=No+Image';
          }
        }
      } catch (error) {
        console.error(`Error loading image for ${skinName}:`, error);
        imageElement.src = 'https://via.placeholder.com/80?text=No+Image';
      }
      imageElement.onerror = function() {
        this.onerror = null;
        this.src = 'https://via.placeholder.com/80?text=No+Image';
      };
    }

    function renderRecentGames() {
        recentGamesList.innerHTML = '';
        if (recentGames.length === 0) {
            noRecentGames.style.display = 'block';
            return;
        }
        noRecentGames.style.display = 'none';
        recentGames.forEach(game => {
            const row = document.createElement('tr');
            const creatorSkins = Array.isArray(game.creator.skins) ? game.creator.skins.join(', ') : game.creator.skins;
            const joinerSkins = Array.isArray(game.joiner.skins) ? game.joiner.skins.join(', ') : game.joiner.skins;
            row.innerHTML = `
                <td>${game.creator.robloxUsername}</td>
                <td>${game.joiner.robloxUsername}</td>
                <td><span class="badge bg-success">${game.winner.robloxUsername}</span></td>
                <td>${creatorSkins} vs ${joinerSkins}</td>
                <td>${formatDate(game.completedAt)}</td>
                <td>
                    <button class="btn btn-sm btn-info view-game-btn" data-game-id="${game.gameId}">Details</button>
                </td>
            `;
            recentGamesList.appendChild(row);
        });
        document.querySelectorAll('.view-game-btn').forEach(button => {
            button.addEventListener('click', () => {
                const gameId = button.getAttribute('data-game-id');
                const game = recentGames.find(g => g.gameId === gameId);
                if (game) {
                    showGameResult(game);
                }
            });
        });
    }

    function renderLeaderboard(leaderboard) {
        leaderboardList.innerHTML = '';
        if (leaderboard.length === 0) {
            noLeaderboard.style.display = 'block';
            return;
        }
        noLeaderboard.style.display = 'none';
        leaderboard.slice(0, 10).forEach((player, index) => {
            const item = document.createElement('li');
            item.className = 'leaderboard-item';
            let rankClass = '';
            if (index === 0) rankClass = 'rank-1';
            else if (index === 1) rankClass = 'rank-2';
            else if (index === 2) rankClass = 'rank-3';
            item.innerHTML = `
                <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                <div class="leaderboard-player">
                    <div class="leaderboard-username">${player.robloxUsername}</div>
                    <div class="leaderboard-stats">${player.wins} wins • ${player.totalGames} games • ${player.winRate}</div>
                </div>
            `;
            leaderboardList.appendChild(item);
        });
    }

    function showNoGames(message) {
        gamesLoading.style.display = 'none';
        activeGamesList.innerHTML = '';
        noGamesMessage.textContent = message || 'No active games. Be the first to create one!';
        noGamesMessage.style.display = 'block';
    }

    function renderUserHistory() {
        historyList.innerHTML = '';
        if (userHistory.length === 0) {
            noHistory.style.display = 'block';
            return;
        }
        noHistory.style.display = 'none';
        const totalGames = userHistory.length;
        const gamesWon = userHistory.filter(game => game.status === 'completed' && game.userWon).length;
        const gamesLost = userHistory.filter(game => game.status === 'completed' && !game.userWon).length;
        const winRate = totalGames > 0 ? Math.round((gamesWon / totalGames) * 100) : 0;
        historyTotalGames.textContent = totalGames;
        historyGamesWon.textContent = gamesWon;
        historyGamesLost.textContent = gamesLost;
        historyWinRate.textContent = `${winRate}%`;
        userHistory.forEach(game => {
            const row = document.createElement('tr');
            let resultClass = '';
            let resultText = '';
            if (game.status === 'completed') {
                if (game.userWon) {
                    resultClass = 'history-result-win';
                    resultText = 'Won';
                } else {
                    resultClass = 'history-result-loss';
                    resultText = 'Lost';
                }
            } else if (game.status === 'cancelled') {
                resultClass = 'history-result-cancelled';
                resultText = 'Cancelled';
            } else {
                resultText = 'Pending';
            }
            const isCreator = game.role === 'creator';
            const opponent = isCreator ?
                (game.joiner ? game.joiner.robloxUsername : 'None') :
                game.creator.robloxUsername;
            const mySkin = isCreator ? 
                (game.creator.skin || (Array.isArray(game.creator.skins) ? game.creator.skins.join(', ') : game.creator.skins)) : 
                (game.joiner ? (game.joiner.skin || (Array.isArray(game.joiner.skins) ? game.joiner.skins.join(', ') : game.joiner.skins)) : 'None');
            const opponentSkin = isCreator ? 
                (game.joiner ? (game.joiner.skin || (Array.isArray(game.joiner.skins) ? game.joiner.skins.join(', ') : game.joiner.skins)) : 'None') : 
                (game.creator.skin || (Array.isArray(game.creator.skins) ? game.creator.skins.join(', ') : game.creator.skins));
            row.innerHTML = `
                <td>${formatDate(game.createdAt)}</td>
                <td>${game.gameId.substring(0, 8)}...</td>
                <td>${isCreator ? 'Creator' : 'Joiner'}</td>
                <td>${opponent}</td>
                <td>${mySkin} vs ${opponentSkin}</td>
                <td class="${resultClass}">${resultText}</td>
                <td>
                    <button class="btn btn-sm btn-info view-history-game-btn" data-game-id="${game.gameId}">
                        Details
                    </button>
                </td>
            `;
            historyList.appendChild(row);
        });
        document.querySelectorAll('.view-history-game-btn').forEach(button => {
            button.addEventListener('click', () => {
                const gameId = button.getAttribute('data-game-id');
                const game = userHistory.find(g => g.gameId === gameId);
                if (game) {
                    historyModal.hide();
                    showGameResult(game);
                }
            });
        });
    }

    function updateSkinSelects() {
        if (!userInventory || !userInventory.length) return;
        
        while (betSkinSelect.options.length > 1) {
            betSkinSelect.remove(1);
        }
        
        while (joinSkinSelect && joinSkinSelect.options.length > 1) {
            joinSkinSelect.remove(1);
        }
        
        const skinCounts = {};
        userInventory.forEach(skinName => {
            skinCounts[skinName] = (skinCounts[skinName] || 0) + 1;
        });
        
        const uniqueSkins = [...new Set(userInventory)];
        
        uniqueSkins.forEach(skinName => {
            const skinDetails = allSkins.find(skin => skin.name === skinName);
            const count = skinCounts[skinName];
            
            const createOption = document.createElement('option');
            createOption.value = skinName;
            createOption.textContent = skinName;
            
            if (skinDetails) {
                createOption.textContent = `${skinName} (${formatValue(skinDetails.value)} value)`;
                if (count > 1) {
                    createOption.textContent += ` [${count}x]`;
                }
                createOption.dataset.rarity = skinDetails.rarity;
                createOption.dataset.value = skinDetails.value;
                createOption.dataset.image = skinDetails.image_url || '';
                createOption.dataset.count = count;
            } else if (count > 1) {
                createOption.textContent += ` [${count}x]`;
            }
            
            betSkinSelect.appendChild(createOption);
            
            if (joinSkinSelect) {
                const joinOption = document.createElement('option');
                joinOption.value = skinName;
                joinOption.textContent = skinName;
                
                if (skinDetails) {
                    joinOption.textContent = `${skinName} (${formatValue(skinDetails.value)} value)`;
                    if (count > 1) {
                        joinOption.textContent += ` [${count}x]`;
                    }
                    joinOption.dataset.rarity = skinDetails.rarity;
                    joinOption.dataset.value = skinDetails.value;
                    joinOption.dataset.image = skinDetails.image_url || '';
                    joinOption.dataset.count = count;
                } else if (count > 1) {
                    joinOption.textContent += ` [${count}x]`;
                }
                
                joinSkinSelect.appendChild(joinOption);
            }
        });
    }

    function getSkinDetails(skinName) {
        return allSkins.find(skin => skin.name === skinName);
    }

    function filterJoinSkinOptions(minimumValue, allowMultiple) {
        console.log("Minimum value required:", minimumValue, "Multiple bets allowed:", allowMultiple);
        
        const totalSelectedValue = joinSelectedSkins.reduce((sum, skin) => sum + skin.value, 0);
        
        const selectedCounts = {};
        joinSelectedSkins.forEach(skin => {
            selectedCounts[skin.name] = (selectedCounts[skin.name] || 0) + 1;
        });
        
        const inventoryCounts = {};
        userInventory.forEach(skinName => {
            inventoryCounts[skinName] = (inventoryCounts[skinName] || 0) + 1;
        });
        
        Array.from(joinSkinSelect.options).forEach(option => {
            if (option.value === '') return;
            
            const skinName = option.value;
            const skinDetails = getSkinDetails(skinName);
            const optionValue = skinDetails ? Number(skinDetails.value) : 0;
            
            const selectedCount = selectedCounts[skinName] || 0;
            
            const inventoryCount = inventoryCounts[skinName] || 0;
            
            let isDisabled = selectedCount >= inventoryCount;
            let disabledReason = '';
            
            if (isDisabled) {
                disabledReason = "All copies selected";
            } else if (!allowMultiple) {
                if (optionValue < minimumValue) {
                    isDisabled = true;
                    disabledReason = "Too low value";
                }
            } else if (totalSelectedValue >= minimumValue) {
                isDisabled = true;
                disabledReason = "Value requirement met";
            }
            
            option.disabled = isDisabled;
            
            if (skinDetails) {
                const countText = inventoryCount > 1 ? ` [${inventoryCount - selectedCount}/${inventoryCount}x]` : '';
                option.textContent = `${skinName} (${formatValue(skinDetails.value)} value)${countText}`;
            } else {
                option.textContent = skinName;
            }
            
            if (isDisabled && disabledReason) {
                option.textContent += ` (${disabledReason})`;
            }
        });
        
        updateValueIndicator();
    }

    async function getSkinWithImage(skinName) {
      if (!skinName) {
        console.warn("Attempted to get skin details for undefined skin");
        return null;
      }
      
      try {
        const cachedSkin = allSkins.find(skin => skin.name === skinName);
        if (cachedSkin && cachedSkin.image_url) {
          return cachedSkin;
        }
        const response = await fetch(`${api}/skin/${encodeURIComponent(skinName)}`);
        if (!response.ok) {
          console.warn(`Failed to fetch skin details for ${skinName}: ${response.status}`);
          return null;
        }
        const skinDetails = await response.json();
        if (!allSkins.some(s => s.name === skinName)) {
          allSkins.push(skinDetails);
        }
        return skinDetails;
      } catch (error) {
        console.error(`Error getting skin details for ${skinName}:`, error);
        return null;
      }
    }


async function showGameResult(game) {
  coin.style.transition = 'none';
  coin.style.transform = 'rotateY(0deg)';
  void coin.offsetWidth;
  
  let creatorSkins = [];
  if (game.creator && game.creator.skins) {
    creatorSkins = Array.isArray(game.creator.skins) ? game.creator.skins :
                   (typeof game.creator.skins === 'string' ? [game.creator.skins] : []);
  } else if (game.creatorSkins) {
    creatorSkins = Array.isArray(game.creatorSkins) ? game.creatorSkins : [game.creatorSkins];
  } else if (game.creator && game.creator.skin) {
    creatorSkins = [game.creator.skin];
  }
  
  let joinerSkins = [];
  if (game.joiner) {
    if (game.joiner.skins) {
      joinerSkins = Array.isArray(game.joiner.skins) ? game.joiner.skins :
                    (typeof game.joiner.skins === 'string' ? [game.joiner.skins] : []);
    } else if (game.joinerSkins) {
      joinerSkins = Array.isArray(game.joinerSkins) ? game.joinerSkins : [game.joinerSkins];
    } else if (game.joiner.skin) {
      joinerSkins = [game.joiner.skin];
    }
  }
  
  let creatorSkinDetails = null;
  let joinerSkinDetails = null;
  try {
    if (creatorSkins.length > 0) {
      creatorSkinDetails = await getSkinWithImage(creatorSkins[0]);
    }
    if (joinerSkins.length > 0) {
      joinerSkinDetails = await getSkinWithImage(joinerSkins[0]);
    }
  } catch (error) {
    console.error("Error fetching skin details:", error);
  }
  
  if (resultCreatorName) {
    resultCreatorName.textContent = game.creator ? game.creator.robloxUsername : "Unknown";
  }
  
  if (resultCreatorSkin) {
    if (creatorSkins.length > 0) {
      resultCreatorSkin.textContent = creatorSkins.length > 1 ?
                              `${creatorSkins[0]} +${creatorSkins.length - 1} more` :
                              creatorSkins[0];
    } else {
      resultCreatorSkin.textContent = 'No skins';
    }
  }
  
  if (resultCreatorValue) {
    const creatorValue = game.creator ?
                        (game.creator.skinValue || game.creator.skinsValue ||
                         game.creatorSkinValue || game.creator.skinValue || 0) : 0;
    resultCreatorValue.textContent = formatValue(creatorValue);
  }
  
  if (creatorSkinImg) {
    if (creatorSkinDetails && creatorSkinDetails.image_url) {
      creatorSkinImg.src = creatorSkinDetails.image_url;
    } else {
      creatorSkinImg.src = 'https://via.placeholder.com/80?text=No+Image';
    }
  }
  
  if (game.joiner) {
    if (resultJoinerName) {
      resultJoinerName.textContent = game.joiner.robloxUsername;
    }
    if (resultJoinerSkin) {
      if (joinerSkins.length > 0) {
        resultJoinerSkin.textContent = joinerSkins.length > 1 ?
                                `${joinerSkins[0]} +${joinerSkins.length - 1} more` :
                                joinerSkins[0];
      } else {
        resultJoinerSkin.textContent = 'No skins';
      }
    }
    if (resultJoinerValue) {
      const joinerValue = game.joiner.skinValue || game.joiner.skinsValue ||
                         game.joinerSkinValue || 0;
      resultJoinerValue.textContent = formatValue(joinerValue);
    }
    if (joinerSkinImg) {
      if (joinerSkinDetails && joinerSkinDetails.image_url) {
        joinerSkinImg.src = joinerSkinDetails.image_url;
      } else {
        joinerSkinImg.src = 'https://via.placeholder.com/80?text=No+Image';
      }
    }
  } else {
    if (resultJoinerName) resultJoinerName.textContent = "No Joiner";
    if (resultJoinerSkin) resultJoinerSkin.textContent = "N/A";
    if (resultJoinerValue) resultJoinerValue.textContent = "0";
    if (joinerSkinImg) joinerSkinImg.src = 'https://via.placeholder.com/80?text=Waiting';
  }
  
  const creatorCardEl = document.querySelector('.creator-card');
  const joinerCardEl = document.querySelector('.joiner-card');
  if (creatorCardEl) creatorCardEl.classList.remove('winner', 'loser');
  if (joinerCardEl) joinerCardEl.classList.remove('winner', 'loser');
  if (winnerInfo) winnerInfo.style.visibility = 'hidden';
  
  if (serverSeed) {
    serverSeed.textContent = game.serverSeed || 'Not revealed yet';
  }
  if (resultClientSeed) {
    resultClientSeed.textContent = game.clientSeed || 'Not available';
  }
  if (resultTitle) {
    resultTitle.textContent = 'Coinflip Game';
    resultTitle.className = 'modal-title';
  }
  if (resultHeader) {
    resultHeader.className = 'modal-header';
  }
  
  if (game.status === 'completed' && game.winner && user) {
  const userParticipated = (game.creator && game.creator.discordId === user.discordId) ||
                         (game.joiner && game.joiner.discordId === user.discordId);
  if (userParticipated) {
    const viewedGames = JSON.parse(localStorage.getItem('viewed_games') || '[]');
    if (!viewedGames.includes(game.gameId)) {
      viewedGames.push(game.gameId);
      localStorage.setItem('viewed_games', JSON.stringify(viewedGames));
    }
  }
}
  gameResultModal.show();
  
  if (game.winner) {
    setTimeout(() => {
      const creatorWon = game.winner.discordId === (game.creator ? game.creator.discordId : null);
      const animationDuration = 4;
      const rotations = 8 + Math.random() * 2;
      const finalRotation = creatorWon ? 0 : 180;
      const totalRotation = Math.floor(rotations) * 360 + finalRotation;
      
      if (coin) {
        coin.style.transition = `transform ${animationDuration}s cubic-bezier(0.18, 0.89, 0.32, 1.28)`;
        coin.style.transform = `rotateY(${totalRotation}deg)`;
      }
      
      setTimeout(() => {
        if (creatorCardEl) creatorCardEl.classList.add(creatorWon ? 'winner' : 'loser');
        if (joinerCardEl) joinerCardEl.classList.add(creatorWon ? 'loser' : 'winner');
        
        if (user && game.winner.discordId === user.discordId) {
          if (winnerInfo) {
            winnerInfo.textContent = `You won and received all skins!`;
            winnerInfo.style.visibility = 'visible';
          }
          if (resultTitle) {
            resultTitle.textContent = '✨ YOU WON! ✨';
            resultTitle.className = 'modal-title text-success';
          }
          if (resultHeader) {
            resultHeader.className = 'modal-header bg-success';
          }
        } else {
          if (winnerInfo) {
            winnerInfo.textContent = `${game.winner.robloxUsername} won and received all skins!`;
            winnerInfo.style.visibility = 'visible';
          }
          if (user && game.status === 'completed' && game.winner.discordId !== user.discordId) {
            if (resultTitle) {
              resultTitle.textContent = 'You Lost';
              resultTitle.className = 'modal-title text-danger';
            }
            if (resultHeader) {
              resultHeader.className = 'modal-header bg-danger';
            }
          } else {
            if (resultTitle) {
              resultTitle.textContent = `${game.winner.robloxUsername} Won!`;
            }
          }
        }
      }, animationDuration * 1000);
    }, 500);
  } else {
    if (winnerInfo) {
      winnerInfo.textContent = game.status === 'cancelled' ? 'Game was cancelled' : 'Game not completed';
      winnerInfo.style.visibility = 'visible';
    }
  }
}



    function openJoinGameModal(gameId) {
      if (!user) {
        AuthClient.login();
        return;
      }
      
      selectedGameId = gameId;
      const game = activeGames.find(g => g.gameId === gameId);
      
      if (!game) {
        alert('Game not found. It may have been cancelled or completed.');
        return;
      }
      
      if (multipleBetsInfo) {
        if (game.allowMultipleBets) {
          multipleBetsInfo.style.display = 'block';
        } else {
          multipleBetsInfo.style.display = 'none';
        }
      }
      
      creatorUsername.textContent = game.creator.robloxUsername;
      
      const creatorAvatarElement = document.getElementById('creator-avatar');
      if (creatorAvatarElement) {
        creatorAvatarElement.textContent = game.creator.robloxUsername.charAt(0).toUpperCase();
      }
      
      creatorSkinsList.innerHTML = '';
      
      const creatorSkins = Array.isArray(game.betSkins) ? game.betSkins :
                          (game.betSkin ? [game.betSkin] : []);
      
      creatorSkins.forEach(async (skinName) => {
        const skinDetails = await getSkinWithImage(skinName);
        const skinItem = document.createElement('div');
        skinItem.style.display = 'flex';
        skinItem.style.alignItems = 'center';
        skinItem.style.gap = '8px';
        skinItem.style.marginBottom = '8px';
        skinItem.innerHTML = `
          <div style="width: 32px; height: 32px; border-radius: 4px; overflow: hidden; background-color: #334155;">
            <img src="${skinDetails?.image_url || 'https://via.placeholder.com/32'}" alt="${skinName}" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <div>
            <div style="font-weight: 500; color: #f8fafc;">${skinName}</div>
            <div style="font-size: 12px; color: #94a3b8;">${formatValue(skinDetails?.value || 0)} value</div>
          </div>
        `;
        creatorSkinsList.appendChild(skinItem);
      });
      
      joinGameForm.reset();
      hideError(joinGameError);
      if (joinSkinPreview) joinSkinPreview.style.display = 'none';
      
      joinSelectedSkins = [];
      updateJoinSelectedSkinsUI();
      
      filterJoinSkinOptions(game.skinValue, game.allowMultipleBets);
      
      joinGameModal.show();
    }

    function openCreateGameModal() {
      if (!user) {
        AuthClient.login();
        return;
      }
      
      createGameForm.reset();
      hideError(createGameError);
      
      if (skinPreview) {
        skinPreview.style.display = 'none';
      }
      
      selectedSkins = [];
      updateSelectedSkinsUI();
      
      if (allowMultipleBetsCheckbox) {
        allowMultipleBetsCheckbox.checked = false;
      }
      
      createGameModal.show();
    }

    function handleCreateGame(event) {
      event.preventDefault();
      if (selectedSkins.length === 0) {
        showError(createGameError, 'Please select at least one skin to bet');
        return;
      }
      const skinNames = selectedSkins.map(skin => skin.name);
      createGame(skinNames);
    }

    function handleJoinGame(event) {
      event.preventDefault();
      if (joinSelectedSkins.length === 0) {
        showError(joinGameError, 'Please select at least one skin to bet');
        return;
      }
      
      const game = activeGames.find(g => g.gameId === selectedGameId);
      if (!game) {
        showError(joinGameError, 'Game not found');
        return;
      }
      
      const totalValue = joinSelectedSkins.reduce((sum, skin) => sum + skin.value, 0);
      if (totalValue < game.skinValue) {
        showError(joinGameError, `Total value (${formatValue(totalValue)}) must be at least ${formatValue(game.skinValue)}`);
        return;
      }
      
      const skinNames = joinSelectedSkins.map(skin => skin.name);
      const seed = clientSeedInput.value.trim();
      joinGame(selectedGameId, skinNames, seed);
    }

    async function handleBetSkinChange() {
      const selected = betSkinSelect.options[betSkinSelect.selectedIndex];
      if (selected.value) {
        if (skinName) skinName.textContent = selected.value;
        let skinDetails = getSkinDetails(selected.value);
        if (!skinDetails || !skinDetails.image_url) {
          skinDetails = await fetchSkinDetails(selected.value);
        }
        if (skinDetails) {
          if (skinRarity) {
            skinRarity.textContent = skinDetails.rarity || 'Common';
            skinRarity.className = `badge bg-${getRarityColor(skinDetails.rarity || 'common')} me-2`;
          }
          if (skinValue) skinValue.textContent = `${formatValue(skinDetails.value || 0)} value`;
          if (skinImage) {
            if (skinDetails.image_url) {
              skinImage.src = skinDetails.image_url;
            } else {
              skinImage.src = 'https://via.placeholder.com/80';
            }
          }
        } else {
          if (skinRarity) {
            skinRarity.textContent = selected.dataset.rarity || 'Common';
            skinRarity.className = `badge bg-${getRarityColor(selected.dataset.rarity || 'common')} me-2`;
          }
          if (skinValue) skinValue.textContent = `${formatValue(selected.dataset.value || 0)} value`;
          if (skinImage) {
            if (selected.dataset.image) {
              skinImage.src = selected.dataset.image;
            } else {
              skinImage.src = 'https://via.placeholder.com/80';
            }
          }
        }
        if (skinPreview) skinPreview.style.display = 'block';
      } else {
        if (skinPreview) skinPreview.style.display = 'none';
      }
    }
      
    async function handleJoinSkinChange() {
      const selected = joinSkinSelect.options[joinSkinSelect.selectedIndex];
      if (selected.value) {
        if (joinSkinName) joinSkinName.textContent = selected.value;
        let skinDetails = getSkinDetails(selected.value);
        if (!skinDetails || !skinDetails.image_url) {
          skinDetails = await fetchSkinDetails(selected.value);
        }
        if (skinDetails) {
          if (joinSkinRarity) {
            joinSkinRarity.textContent = skinDetails.rarity || 'Common';
            joinSkinRarity.className = `badge bg-${getRarityColor(skinDetails.rarity || 'common')} me-2`;
          }
          if (joinSkinValue) joinSkinValue.textContent = `${formatValue(skinDetails.value || 0)} value`;
          if (joinSkinImage) {
            if (skinDetails.image_url) {
              joinSkinImage.src = skinDetails.image_url;
            } else {
              joinSkinImage.src = 'https://via.placeholder.com/80';
            }
          }
        } else {
          if (joinSkinRarity) {
            joinSkinRarity.textContent = selected.dataset.rarity || 'Common';
            joinSkinRarity.className = `badge bg-${getRarityColor(selected.dataset.rarity || 'common')} me-2`;
          }
          if (joinSkinValue) joinSkinValue.textContent = `${formatValue(selected.dataset.value || 0)} value`;
          if (joinSkinImage) {
            if (selected.dataset.image) {
              joinSkinImage.src = selected.dataset.image;
            } else {
              joinSkinImage.src = 'https://via.placeholder.com/80';
            }
          }
        }
        if (joinSkinPreview) joinSkinPreview.style.display = 'block';
      } else {
        if (joinSkinPreview) joinSkinPreview.style.display = 'none';
      }
    }
    
    async function init() {
      joinSkinPreview = document.getElementById('join-skin-preview');
      joinSkinImage = document.getElementById('join-skin-image');
      joinSkinName = document.getElementById('join-skin-name');
      joinSkinRarity = document.getElementById('join-skin-rarity');
      joinSkinValue = document.getElementById('join-skin-value');
      await updateAuthUI();
      const pendingApprovalsPromise = fetchPendingApprovals();
      await Promise.all([
        fetchActiveGames(),
        fetchRecentGames(),
        fetchLeaderboard(),
        fetchStats(),
        fetchSkins(),
        initWagerTracker()
      ]);
      const pendingApprovals = await pendingApprovalsPromise;
      if (pendingApprovals && pendingApprovals.length > 0) {
        renderPendingApprovals(pendingApprovals);
        showNotification(
          'Pending Approvals',
          `You have ${pendingApprovals.length} game${pendingApprovals.length > 1 ? 's' : ''} waiting for your approval.`,
          'View',
          () => {
            const pendingApprovalsSection = document.querySelector('.card-header');
            if (pendingApprovalsSection) {
              pendingApprovalsSection.scrollIntoView({ behavior: 'smooth' });
            }
          }
        );
      }
      setInterval(fetchActiveGames, 5000);
      setInterval(checkForNewJoins, 3000);
      setInterval(pollCompletedGames, 3000);
      setInterval(checkForRejectedJoins, 3000);
      setInterval(checkForNotifications, 3000); 

      setInterval(async () => {
        const pendingApprovals = await fetchPendingApprovals();
        if (pendingApprovals.length > 0) {
          const existingSection = document.querySelector('.card-header');
          if (!existingSection || !existingSection.textContent.includes('Pending Approvals')) {
            renderPendingApprovals(pendingApprovals);
          }
        }
      }, 3000);
      if (loginBtn) {
        loginBtn.addEventListener('click', () => AuthClient.login());
      }
      if (loginBtnCard) {
        loginBtnCard.addEventListener('click', () => AuthClient.login());
      }
      if (addSkinBtn) {
        addSkinBtn.addEventListener('click', addSelectedSkin);
      }
      if (addJoinSkinBtn) {
        addJoinSkinBtn.addEventListener('click', addJoinSelectedSkin);
      }
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => AuthClient.logout());
      }
      if (createGameBtn) {
        createGameBtn.addEventListener('click', openCreateGameModal);
      }
      if (createGameSubmitBtn) {
        createGameSubmitBtn.addEventListener('click', handleCreateGame);
      }
      if (betSkinSelect) {
        betSkinSelect.addEventListener('change', async () => await handleBetSkinChange());
      }
      if (joinGameSubmitBtn) {
        joinGameSubmitBtn.addEventListener('click', handleJoinGame);
      }
      if (joinSkinSelect) {
        joinSkinSelect.addEventListener('change', async () => await handleJoinSkinChange());
      }
      if (generateSeedBtn) {
        generateSeedBtn.addEventListener('click', () => {
          clientSeedInput.value = generateRandomSeed();
        });
      }
      if (viewHistoryBtn) {
        viewHistoryBtn.addEventListener('click', () => {
          if (user) {
            renderUserHistory();
            historyModal.show();
          }
        });
      }
      if (playAgainBtn) {
        playAgainBtn.addEventListener('click', () => {
          gameResultModal.hide();
          openCreateGameModal();
        });
      }
      if (user) {
        checkForNewJoins();
      }
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>